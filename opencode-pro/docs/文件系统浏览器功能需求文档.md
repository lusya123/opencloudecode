# 文件系统浏览器功能需求文档

## 1. 功能概述

在现有侧边栏中添加一个新的"文件系统"Tab，与现有的"Workspace"和"定时任务"Tab 并列。该 Tab 提供完整的文件系统浏览功能，允许用户浏览本地文件系统，并通过拖拽将文件路径添加到右侧对话框中。

## 2. 功能需求

### 2.1 Tab 结构

- **位置**：在侧边栏中添加第三个 Tab，与 Workspace 和定时任务 Tab 平级
- **图标**：使用文件夹或文件系统相关的图标
- **标题**：文件系统 / File System

### 2.2 目录浏览功能

#### 2.2.1 起始目录
- **默认起始目录**：当前项目的根目录
- **目录切换功能**：提供两个入口：
  - **项目主目录**：当前项目的根目录（默认）
  - **根目录**：通用文件访问入口（系统根目录 `/`），支持通过**地址栏**输入任意路径并直接跳转

#### 2.2.2 目录树展示
- **树形结构**：以树形结构展示目录和文件
- **展开/折叠**：
  - 点击目录可展开/折叠子目录
  - 支持多级目录嵌套
  - 保持展开/折叠状态（可选：持久化到 localStorage）
- **文件显示**：
  - 显示所有文件，包括隐藏文件（以 `.` 开头的文件）
  - 不过滤任何文件类型
  - 显示文件和目录的图标（与系统整体风格一致）

#### 2.2.3 权限处理
- **无权限目录**：对于当前用户无读取权限的目录，显示提示信息（如"无权限访问"）
- **错误处理**：对于读取失败的目录，显示友好的错误提示

### 2.3 拖拽功能

#### 2.3.1 拖拽源
- **可拖拽元素**：文件系统 Tab 中的所有文件和目录
- **拖拽指示**：拖拽时显示视觉反馈（如半透明的文件图标）

#### 2.3.2 拖拽目标
- **目标区域**：右侧对话框的输入框区域
- **放置指示**：当拖拽到有效区域时，显示可放置的视觉提示

#### 2.3.3 拖拽行为
- **路径格式**：插入文件/目录的绝对路径
- **插入格式**：纯文本路径（如 `/Users/username/project/file.txt`）
- **多文件拖拽**：
  - 支持同时选中并拖拽多个文件
  - 多个路径以换行符分隔插入
  - 或以空格分隔（根据实际使用场景确定）
- **插入位置**：插入到输入框的当前光标位置

### 2.4 性能优化

#### 2.4.1 虚拟滚动
- **触发条件**：当目录包含大量文件时（如超过 100 个项目）
- **实现方式**：使用虚拟滚动技术，只渲染可见区域的文件项
- **目的**：避免大量 DOM 节点导致的性能问题

#### 2.4.2 懒加载
- **目录内容**：仅在展开目录时加载其子内容
- **避免预加载**：不预先加载所有目录的内容

### 2.5 UI/UX 设计

#### 2.5.1 图标系统
- **文件图标**：根据文件类型显示对应图标
- **目录图标**：统一的文件夹图标（展开/折叠状态可有不同图标）
- **风格一致性**：与系统整体 UI 风格保持一致

#### 2.5.2 交互设计
- **点击行为**：
  - 点击目录：展开/折叠
  - 点击文件：选中（为拖拽做准备）
- **多选支持**：
  - 按住 Ctrl/Cmd 键点击：多选
  - 按住 Shift 键点击：范围选择
- **视觉反馈**：
  - 选中状态：高亮显示
  - 悬停状态：轻微背景色变化
  - 拖拽状态：半透明效果

#### 2.5.3 简化设计
- **不显示元信息**：不显示文件大小、修改时间等
- **无右键菜单**：不提供右键菜单功能
- **无搜索功能**：暂不实现文件搜索功能

## 3. 技术实现要点

### 3.1 技术栈
- **框架**：SolidJS（与现有代码保持一致）
- **拖拽库**：`@thisbeyond/solid-dnd`（与现有 Workspace Tab 一致）
- **UI 组件**：`@opencode-ai/ui`（使用现有的 Collapsible、Tabs 等组件）
- **虚拟滚动**：`@tanstack/solid-virtual` 或类似库

### 3.2 核心组件

#### 3.2.1 FileSystemTab 组件
- **位置**：`packages/app/src/components/file-system-tab.tsx`
- **职责**：
  - 管理文件系统 Tab 的整体布局
  - 提供目录切换功能
  - 渲染文件树组件

#### 3.2.2 FileSystemTree 组件
- **位置**：`packages/app/src/components/file-system-tree.tsx`
- **职责**：
  - 递归渲染目录树结构
  - 处理展开/折叠逻辑
  - 实现拖拽功能
  - 集成虚拟滚动

#### 3.2.3 FileSystemItem 组件
- **职责**：
  - 渲染单个文件或目录项
  - 处理点击、选中、拖拽事件
  - 显示图标和名称

### 3.3 状态管理

#### 3.3.1 全局状态（Layout Context）
- **当前根目录**：记录当前浏览的根目录路径
- **展开的目录**：记录哪些目录处于展开状态
- **选中的文件**：记录当前选中的文件/目录列表

#### 3.3.2 本地状态
- **目录内容缓存**：缓存已加载的目录内容，避免重复请求
- **加载状态**：标记正在加载的目录

### 3.4 API 接口

#### 3.4.1 读取目录内容
```typescript
interface ReadDirRequest {
  path: string;
}

interface ReadDirResponse {
  success: boolean;
  items: FileSystemItem[];
  error?: string;
}

interface FileSystemItem {
  name: string;
  path: string;
  type: 'file' | 'directory';
  isReadable: boolean;
}
```

#### 3.4.2 获取特殊目录路径
```typescript
interface GetSpecialPathsResponse {
  projectRoot: string;
  userHome: string;
  systemRoot: string;
}
```

### 3.5 拖拽实现

#### 3.5.1 拖拽数据格式
```typescript
interface DragData {
  type: 'file-system-paths';
  paths: string[];
}
```

#### 3.5.2 与对话框集成
- **监听 drop 事件**：在右侧对话框输入框上监听 drop 事件
- **提取路径**：从拖拽数据中提取文件路径
- **插入文本**：将路径插入到输入框的光标位置

## 4. 用户场景

### 4.1 基本浏览场景
1. 用户点击侧边栏的"文件系统"Tab
2. 默认显示当前项目根目录的内容
3. 用户点击目录展开，查看子目录和文件
4. 用户可以逐级浏览整个文件系统

### 4.2 切换根目录场景
1. 用户点击目录切换按钮
2. 选择"用户主目录"或"系统根目录"
3. 文件树刷新，显示新根目录的内容

### 4.3 拖拽文件路径场景
1. 用户在文件系统 Tab 中找到目标文件
2. 点击并拖拽文件到右侧对话框
3. 文件的绝对路径被插入到输入框中
4. 用户可以继续编辑或发送消息

### 4.4 多文件拖拽场景
1. 用户按住 Ctrl/Cmd 键选中多个文件
2. 拖拽选中的文件到右侧对话框
3. 多个文件路径被插入（每行一个或空格分隔）

## 5. 非功能需求

### 5.1 性能要求
- **目录加载**：单个目录内容加载时间 < 500ms
- **展开/折叠**：响应时间 < 100ms
- **拖拽响应**：拖拽操作流畅，无明显延迟
- **大目录处理**：包含 1000+ 文件的目录仍能流畅滚动

### 5.2 兼容性要求
- **浏览器**：支持现代浏览器（Chrome、Firefox、Safari、Edge）
- **操作系统**：支持 Windows、macOS、Linux
- **响应式**：适配不同屏幕尺寸（桌面端优先）

### 5.3 可访问性
- **键盘导航**：支持键盘上下键浏览文件树
- **焦点管理**：清晰的焦点指示
- **屏幕阅读器**：提供适当的 ARIA 标签

## 6. 未来扩展（暂不实现）

以下功能在当前版本中不实现，但可作为未来扩展方向：

- 文件搜索功能
- 文件类型过滤
- 右键菜单（复制路径、在系统中打开等）
- 显示文件元信息（大小、修改时间等）
- 文件预览功能
- 收藏夹/快捷访问
- 最近访问的文件列表

## 7. 验收标准

### 7.1 功能验收
- [ ] 文件系统 Tab 正确显示在侧边栏中
- [ ] 默认显示项目根目录内容
- [ ] 可以切换到用户主目录和系统根目录
- [ ] 目录可以正常展开/折叠
- [ ] 显示所有文件，包括隐藏文件
- [ ] 无权限目录显示友好提示
- [ ] 单个文件可以拖拽到对话框
- [ ] 多个文件可以同时拖拽
- [ ] 拖拽后插入正确的绝对路径
- [ ] 大目录使用虚拟滚动，性能良好

### 7.2 UI 验收
- [ ] 图标与系统风格一致
- [ ] 选中、悬停、拖拽状态有明确视觉反馈
- [ ] 布局与现有 Tab 保持一致
- [ ] 响应式设计适配不同屏幕

### 7.3 性能验收
- [ ] 目录加载时间符合要求
- [ ] 大目录滚动流畅
- [ ] 拖拽操作无延迟

## 8. 实现优先级

### P0（必须实现）
- 文件系统 Tab 基本结构
- 目录树展示和展开/折叠
- 从项目根目录开始浏览
- 单文件拖拽到对话框

### P1（重要）
- 目录切换功能（主目录、根目录）
- 多文件拖拽
- 虚拟滚动优化
- 权限错误处理

### P2（可选）
- 展开状态持久化
- 键盘导航
- 更丰富的视觉反馈

---

**文档版本**：v1.0
**创建日期**：2026-01-16
**最后更新**：2026-01-16
