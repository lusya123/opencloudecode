# 侧边栏终端功能需求文档

## 1. 功能概述

在现有侧边栏中添加一个新的"终端"按钮,与现有的"Workspace"、"文件系统"和"定时任务"按钮并列。该按钮用于控制右侧对话界面中终端面板的显示/隐藏,实现对话界面与终端界面的分屏显示。

## 2. 功能需求

### 2.1 按钮结构

- **位置**:在侧边栏中添加第四个按钮,与 Workspace、文件系统和定时任务按钮平级
- **图标**:使用终端相关的图标(如 `terminal` 或 `console`)
- **标题**:终端 / Terminal

### 2.2 按钮行为

#### 2.2.1 点击行为
- **首次点击**:
  - 左侧边栏保持当前状态不变(不切换标签页)
  - 右侧对话界面分成两部分:上部分为 AI 对话界面,下部分为终端界面
  - 终端面板从底部滑入或直接显示

- **再次点击**:
  - 隐藏终端面板
  - 右侧对话界面恢复为全屏显示
  - 左侧边栏状态保持不变

#### 2.2.2 状态独立性
- **与标签页解耦**:终端的显示/隐藏状态与左侧标签页(Workspace/文件系统/定时任务)的切换完全独立
- **状态保持**:在不同标签页之间切换时,终端的显示/隐藏状态保持不变
- **按钮状态**:终端按钮有明确的激活/未激活视觉状态

### 2.3 终端面板布局

#### 2.3.1 分屏布局
- **垂直分割**:右侧界面垂直分为上下两部分
- **上部分**:AI 对话界面(保持原有功能)
- **下部分**:终端界面

#### 2.3.2 可调节大小
- **拖动分隔条**:在对话界面和终端界面之间添加可拖动的分隔条
- **拖动方向**:垂直拖动,调节上下两部分的高度比例
- **最小高度限制**:
  - 对话界面最小高度:200px(确保能看到至少几条消息)
  - 终端界面最小高度:150px(确保能看到至少几行命令)
- **默认比例**:对话界面 60%,终端界面 40%
- **状态持久化**:记住用户调节后的比例,下次打开时恢复

#### 2.3.3 响应式设计
- **桌面端**:使用上下分屏布局
- **移动端**:考虑使用标签页切换或全屏模式(可选)

### 2.4 终端功能

#### 2.4.1 终端连接
- **连接目标**:本地机器的终端(PTY)
- **工作目录**:当前选中项目的根目录
- **Shell 类型**:使用系统默认 Shell(bash/zsh/powershell 等)

#### 2.4.2 终端能力
- **命令执行**:支持执行任何终端命令
- **交互式命令**:支持需要用户输入的交互式命令
- **颜色支持**:支持 ANSI 颜色代码
- **复制粘贴**:支持文本的复制和粘贴
- **快捷键**:支持常用终端快捷键(Ctrl+C、Ctrl+D 等)

#### 2.4.3 终端状态
- **连接状态**:显示终端连接状态(连接中/已连接/断开)
- **错误处理**:连接失败时显示友好的错误提示
- **重连机制**:连接断开时提供重连选项

### 2.5 UI/UX 设计

#### 2.5.1 视觉设计
- **分隔条样式**:
  - 默认状态:细线(1-2px),颜色与主题一致
  - 悬停状态:加粗或高亮,提示可拖动
  - 拖动状态:显示拖动指示器
- **终端面板**:
  - 背景色:深色背景(与终端主题一致)
  - 边框:与对话界面有明确的视觉分隔
  - 标题栏:显示"终端"标题和关闭按钮(可选)

#### 2.5.2 交互反馈
- **按钮状态**:
  - 未激活:默认样式
  - 激活:高亮显示(与其他标签页激活状态一致)
  - 悬停:轻微背景色变化
- **面板动画**:
  - 显示:从底部滑入或淡入(可选)
  - 隐藏:向底部滑出或淡出(可选)
  - 动画时长:200-300ms

#### 2.5.3 焦点管理
- **自动聚焦**:终端面板显示时,自动聚焦到终端输入区域
- **焦点切换**:支持在对话输入框和终端之间快速切换焦点

### 2.6 与现有功能的集成

#### 2.6.1 与对话界面的关系
- **独立滚动**:对话界面和终端界面各自独立滚动
- **输入框位置**:对话输入框保持在对话界面底部
- **消息显示**:对话消息在对话界面中正常显示,不受终端影响

#### 2.6.2 与现有终端标签页的关系
- **复用终端组件**:使用现有的 Terminal 组件(`@/components/terminal.tsx`)
- **终端实例**:侧边栏终端与对话界面顶部的终端标签页共享终端实例管理
- **状态同步**:如果用户在对话界面顶部打开了终端标签页,侧边栏终端显示相同的终端实例(可选)

## 3. 技术实现要点

### 3.1 技术栈
- **框架**:SolidJS(与现有代码保持一致)
- **终端组件**:复用现有的 `Terminal` 组件
- **终端库**:`ghostty-web`(与现有实现一致)
- **UI 组件**:`@opencode-ai/ui`(使用 ResizeHandle 组件)

### 3.2 核心组件

#### 3.2.1 修改 SchedulerContext
- **位置**:`packages/app/src/context/scheduler.tsx`
- **新增状态**:
  ```typescript
  interface SchedulerState {
    // ... 现有状态
    terminalVisible: boolean  // 终端面板是否可见
  }
  ```
- **新增方法**:
  ```typescript
  interface SchedulerContextValue {
    // ... 现有方法
    toggleTerminal: () => void  // 切换终端显示/隐藏
    setTerminalVisible: (visible: boolean) => void  // 设置终端可见性
  }
  ```

#### 3.2.2 修改 Layout 组件
- **位置**:`packages/app/src/pages/layout.tsx`
- **修改内容**:
  - 在侧边栏按钮区域添加"终端"按钮
  - 按钮点击时调用 `scheduler.toggleTerminal()`
  - 按钮激活状态绑定到 `scheduler.state.terminalVisible`

#### 3.2.3 修改 Session 组件
- **位置**:`packages/app/src/pages/session.tsx`
- **修改内容**:
  - 根据 `scheduler.state.terminalVisible` 控制终端面板显示
  - 添加可调节大小的分隔条(使用 `ResizeHandle` 组件)
  - 实现对话界面和终端界面的垂直分屏布局
  - 管理分屏比例状态并持久化到 localStorage

### 3.3 状态管理

#### 3.3.1 全局状态(Scheduler Context)
- **终端可见性**:`terminalVisible: boolean`
- **分屏比例**:`terminalSplitRatio: number`(0-1 之间,表示终端占总高度的比例)

#### 3.3.2 本地状态(Session 组件)
- **拖动状态**:`isDragging: boolean`
- **临时比例**:`tempRatio: number`(拖动过程中的临时比例)

#### 3.3.3 持久化
- **存储位置**:localStorage
- **存储内容**:
  ```typescript
  {
    terminalSplitRatio: 0.4  // 终端占 40%
  }
  ```

### 3.4 布局实现

#### 3.4.1 CSS Flexbox 布局
```css
.session-container {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.chat-area {
  flex: 1;
  min-height: 200px;
  overflow-y: auto;
}

.resize-handle {
  height: 4px;
  cursor: ns-resize;
}

.terminal-area {
  flex: 0 0 auto;
  min-height: 150px;
  overflow: hidden;
}
```

#### 3.4.2 动态高度计算
```typescript
// 根据 terminalSplitRatio 计算高度
const chatHeight = `${(1 - terminalSplitRatio) * 100}%`
const terminalHeight = `${terminalSplitRatio * 100}%`
```

### 3.5 拖动实现

#### 3.5.1 拖动事件处理
```typescript
function handleMouseDown(e: MouseEvent) {
  setIsDragging(true)
  // 记录初始位置
}

function handleMouseMove(e: MouseEvent) {
  if (!isDragging) return
  // 计算新的比例
  const newRatio = calculateRatio(e.clientY)
  setTempRatio(clamp(newRatio, 0.2, 0.8))
}

function handleMouseUp() {
  setIsDragging(false)
  // 保存比例到 localStorage
  saveRatioToStorage(tempRatio)
}
```

#### 3.5.2 边界限制
- **最小比例**:0.2(终端最小占 20%)
- **最大比例**:0.8(终端最大占 80%)

## 4. 用户场景

### 4.1 基本使用场景
1. 用户在左侧边栏点击"终端"按钮
2. 右侧对话界面分成两部分,下方显示终端
3. 终端自动连接到当前项目根目录
4. 用户在终端中执行命令(如 `npm install`)
5. 用户继续在上方的对话界面与 AI 交流
6. 用户再次点击"终端"按钮,终端隐藏

### 4.2 调节大小场景
1. 用户显示终端后,发现终端区域太小
2. 用户将鼠标悬停在分隔条上,光标变为调节大小图标
3. 用户拖动分隔条向上,扩大终端区域
4. 释放鼠标后,新的比例被保存
5. 下次打开终端时,自动恢复上次的比例

### 4.3 多任务场景
1. 用户在 Workspace 标签页查看项目列表
2. 用户点击"终端"按钮,显示终端
3. 用户在终端中运行构建命令
4. 用户切换到"文件系统"标签页浏览文件
5. 终端继续在右侧显示,构建命令继续执行
6. 用户切换回 Workspace,终端仍然可见

### 4.4 与 AI 协作场景
1. 用户向 AI 询问如何运行项目
2. AI 在对话界面中给出命令建议
3. 用户点击"终端"按钮,显示终端
4. 用户将 AI 建议的命令复制到终端执行
5. 用户在对话界面中向上滚动查看 AI 的其他建议
6. 终端继续显示命令执行结果

## 5. 非功能需求

### 5.1 性能要求
- **终端连接**:连接时间 < 1s
- **面板显示/隐藏**:动画流畅,无卡顿
- **拖动响应**:拖动分隔条时实时更新,无延迟
- **终端渲染**:大量输出时保持流畅(依赖 ghostty-web 性能)

### 5.2 兼容性要求
- **浏览器**:支持现代浏览器(Chrome、Firefox、Safari、Edge)
- **操作系统**:支持 Windows、macOS、Linux
- **响应式**:适配不同屏幕尺寸(桌面端优先)

### 5.3 可访问性
- **键盘导航**:支持键盘快捷键切换终端显示
- **焦点管理**:清晰的焦点指示
- **屏幕阅读器**:提供适当的 ARIA 标签

### 5.4 稳定性
- **连接恢复**:终端连接断开时自动尝试重连
- **状态保存**:页面刷新后恢复终端显示状态和分屏比例
- **错误处理**:终端错误不影响对话界面的正常使用

## 6. 未来扩展(暂不实现)

以下功能在当前版本中不实现,但可作为未来扩展方向:

- 多终端实例支持(在侧边栏终端中切换不同的终端标签页)
- 终端历史记录搜索
- 终端输出保存到文件
- 终端主题自定义
- 终端字体大小调节
- 分屏布局切换(左右分屏 vs 上下分屏)
- 终端快捷操作菜单(清屏、复制全部等)
- 与 AI 对话的深度集成(AI 建议的命令一键发送到终端)

## 7. 验收标准

### 7.1 功能验收
- [ ] "终端"按钮正确显示在侧边栏中
- [ ] 点击按钮可以显示/隐藏终端面板
- [ ] 终端面板显示时,对话界面和终端界面正确分屏
- [ ] 分隔条可以拖动,调节两部分的高度比例
- [ ] 分屏比例有最小/最大限制
- [ ] 分屏比例持久化,刷新后恢复
- [ ] 终端连接到当前项目根目录
- [ ] 终端可以执行任何命令
- [ ] 终端支持颜色、复制粘贴等基本功能
- [ ] 切换左侧标签页时,终端状态保持不变
- [ ] 终端按钮有明确的激活/未激活状态

### 7.2 UI 验收
- [ ] 按钮图标和样式与其他按钮一致
- [ ] 分隔条有明确的视觉提示(悬停时)
- [ ] 终端面板与对话界面有清晰的视觉分隔
- [ ] 面板显示/隐藏动画流畅(如果有)
- [ ] 拖动分隔条时有实时反馈

### 7.3 性能验收
- [ ] 终端连接时间符合要求
- [ ] 面板显示/隐藏无卡顿
- [ ] 拖动分隔条流畅,无延迟
- [ ] 终端大量输出时不影响对话界面

### 7.4 交互验收
- [ ] 终端显示时自动聚焦
- [ ] 支持在对话输入框和终端之间切换焦点
- [ ] 对话界面和终端界面各自独立滚动
- [ ] 终端连接失败时有友好提示

## 8. 实现优先级

### P0(必须实现)
- 侧边栏"终端"按钮
- 终端面板显示/隐藏功能
- 基本的上下分屏布局
- 终端连接到项目根目录
- 复用现有 Terminal 组件

### P1(重要)
- 可拖动的分隔条
- 分屏比例调节
- 分屏比例持久化
- 最小高度限制
- 按钮激活状态显示

### P2(可选)
- 面板显示/隐藏动画
- 键盘快捷键支持
- 移动端适配
- 终端自动聚焦

## 9. 技术风险与挑战

### 9.1 布局复杂度
- **风险**:在现有复杂的布局中添加可调节的分屏可能导致布局冲突
- **缓解**:仔细测试各种屏幕尺寸和布局状态,使用 Flexbox 确保布局灵活性

### 9.2 状态管理
- **风险**:终端状态与标签页状态的独立性可能导致状态管理复杂
- **缓解**:在 SchedulerContext 中清晰定义状态和方法,确保状态更新逻辑简单明了

### 9.3 性能影响
- **风险**:同时渲染对话界面和终端可能影响性能
- **缓解**:终端组件已经过优化(使用 ghostty-web),对话界面使用虚拟滚动,性能影响应该可控

### 9.4 用户体验
- **风险**:分屏可能让界面显得拥挤,影响用户体验
- **缓解**:提供合理的默认比例,允许用户自由调节,确保两部分都有足够的最小高度

## 10. 实现步骤建议

### 第一阶段:基础功能
1. 修改 `scheduler.tsx`,添加 `terminalVisible` 状态和相关方法
2. 修改 `layout.tsx`,添加"终端"按钮
3. 修改 `session.tsx`,添加基本的分屏布局(固定比例)
4. 测试基本的显示/隐藏功能

### 第二阶段:可调节大小
1. 在 `session.tsx` 中添加 `ResizeHandle` 组件
2. 实现拖动逻辑和比例计算
3. 添加最小高度限制
4. 测试拖动功能

### 第三阶段:状态持久化
1. 实现分屏比例的 localStorage 存储
2. 页面加载时恢复保存的比例
3. 测试刷新后的状态恢复

### 第四阶段:优化和完善
1. 添加面板显示/隐藏动画(可选)
2. 优化按钮激活状态显示
3. 添加键盘快捷键支持(可选)
4. 全面测试各种场景和边界情况

---

**文档版本**:v1.0
**创建日期**:2026-01-16
**最后更新**:2026-01-16
