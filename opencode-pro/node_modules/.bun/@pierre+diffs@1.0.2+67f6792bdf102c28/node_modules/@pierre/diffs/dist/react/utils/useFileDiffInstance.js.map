{"version":3,"file":"useFileDiffInstance.js","names":[],"sources":["../../../src/react/utils/useFileDiffInstance.ts"],"sourcesContent":["import {\n  useCallback,\n  useContext,\n  useEffect,\n  useLayoutEffect,\n  useRef,\n} from 'react';\n\nimport { FileDiff, type FileDiffOptions } from '../../components/FileDiff';\nimport type { SelectedLineRange } from '../../managers/LineSelectionManager';\nimport type { GetHoveredLineResult } from '../../managers/MouseEventManager';\nimport type {\n  DiffLineAnnotation,\n  FileContents,\n  FileDiffMetadata,\n} from '../../types';\nimport { areOptionsEqual } from '../../utils/areOptionsEqual';\nimport { WorkerPoolContext } from '../WorkerPoolContext';\nimport { useStableCallback } from './useStableCallback';\n\nconst useIsometricEffect =\n  typeof window === 'undefined' ? useEffect : useLayoutEffect;\n\ninterface UseFileDiffInstanceProps<LAnnotation> {\n  oldFile?: FileContents;\n  newFile?: FileContents;\n  fileDiff?: FileDiffMetadata;\n  options: FileDiffOptions<LAnnotation> | undefined;\n  lineAnnotations: DiffLineAnnotation<LAnnotation>[] | undefined;\n  selectedLines: SelectedLineRange | null | undefined;\n  prerenderedHTML: string | undefined;\n}\n\ninterface UseFileDiffInstanceReturn {\n  ref(node: HTMLElement | null): void;\n  getHoveredLine(): GetHoveredLineResult<'diff'> | undefined;\n}\n\nexport function useFileDiffInstance<LAnnotation>({\n  oldFile,\n  newFile,\n  fileDiff,\n  options,\n  lineAnnotations,\n  selectedLines,\n  prerenderedHTML,\n}: UseFileDiffInstanceProps<LAnnotation>): UseFileDiffInstanceReturn {\n  const poolManager = useContext(WorkerPoolContext);\n  const instanceRef = useRef<FileDiff<LAnnotation> | null>(null);\n  const ref = useStableCallback((fileContainer: HTMLElement | null) => {\n    if (fileContainer != null) {\n      if (instanceRef.current != null) {\n        throw new Error(\n          'useFileDiffInstance: An instance should not already exist when a node is created'\n        );\n      }\n      // FIXME: Ideally we don't use FileDiffUI here, and instead amalgamate\n      // the renderers manually\n      instanceRef.current = new FileDiff(options, poolManager, true);\n      void instanceRef.current.hydrate({\n        fileDiff,\n        oldFile,\n        newFile,\n        fileContainer,\n        lineAnnotations,\n        prerenderedHTML,\n      });\n    } else {\n      if (instanceRef.current == null) {\n        throw new Error(\n          'useFileDiffInstance: A FileDiff instance should exist when unmounting'\n        );\n      }\n      instanceRef.current.cleanUp();\n      instanceRef.current = null;\n    }\n  });\n\n  useIsometricEffect(() => {\n    if (instanceRef.current == null) return;\n    const instance = instanceRef.current;\n    const forceRender = !areOptionsEqual(instance.options, options);\n    instance.setOptions(options);\n    void instance.render({\n      forceRender,\n      fileDiff,\n      oldFile,\n      newFile,\n      lineAnnotations,\n    });\n    if (selectedLines !== undefined) {\n      instance.setSelectedLines(selectedLines);\n    }\n  });\n\n  const getHoveredLine = useCallback(():\n    | GetHoveredLineResult<'diff'>\n    | undefined => {\n    return instanceRef.current?.getHoveredLine();\n  }, []);\n\n  return { ref, getHoveredLine };\n}\n"],"mappings":";;;;;;;AAoBA,MAAM,qBACJ,OAAO,WAAW,cAAc,YAAY;AAiB9C,SAAgB,oBAAiC,EAC/C,SACA,SACA,UACA,SACA,iBACA,eACA,mBACmE;CACnE,MAAM,cAAc,WAAW,kBAAkB;CACjD,MAAM,cAAc,OAAqC,KAAK;CAC9D,MAAM,MAAM,mBAAmB,kBAAsC;AACnE,MAAI,iBAAiB,MAAM;AACzB,OAAI,YAAY,WAAW,KACzB,OAAM,IAAI,MACR,mFACD;AAIH,eAAY,UAAU,IAAI,SAAS,SAAS,aAAa,KAAK;AAC9D,GAAK,YAAY,QAAQ,QAAQ;IAC/B;IACA;IACA;IACA;IACA;IACA;IACD,CAAC;SACG;AACL,OAAI,YAAY,WAAW,KACzB,OAAM,IAAI,MACR,wEACD;AAEH,eAAY,QAAQ,SAAS;AAC7B,eAAY,UAAU;;GAExB;AAEF,0BAAyB;AACvB,MAAI,YAAY,WAAW,KAAM;EACjC,MAAM,WAAW,YAAY;EAC7B,MAAM,cAAc,CAAC,gBAAgB,SAAS,SAAS,QAAQ;AAC/D,WAAS,WAAW,QAAQ;AAC5B,EAAK,SAAS,OAAO;GACnB;GACA;GACA;GACA;GACA;GACD,CAAC;AACF,MAAI,kBAAkB,OACpB,UAAS,iBAAiB,cAAc;GAE1C;AAQF,QAAO;EAAE;EAAK,gBANS,kBAEN;AACf,UAAO,YAAY,SAAS,gBAAgB;KAC3C,EAAE,CAAC;EAEwB"}