{"version":3,"file":"preloadDiffs.js","names":[],"sources":["../../src/ssr/preloadDiffs.ts"],"sourcesContent":["import type { FileDiffOptions } from '../components/FileDiff';\nimport { DiffHunksRenderer } from '../renderers/DiffHunksRenderer';\nimport type {\n  DiffLineAnnotation,\n  FileContents,\n  FileDiffMetadata,\n} from '../types';\nimport { createStyleElement } from '../utils/createStyleElement';\nimport { getSingularPatch } from '../utils/getSingularPatch';\nimport { parseDiffFromFile } from '../utils/parseDiffFromFile';\nimport { renderHTML } from './renderHTML';\n\nexport interface PreloadDiffOptions<LAnnotation> {\n  fileDiff?: FileDiffMetadata;\n  oldFile?: FileContents;\n  newFile?: FileContents;\n  options?: FileDiffOptions<LAnnotation>;\n  annotations?: DiffLineAnnotation<LAnnotation>[];\n}\n\nexport async function preloadDiffHTML<LAnnotation = undefined>({\n  fileDiff,\n  oldFile,\n  newFile,\n  options,\n  annotations,\n}: PreloadDiffOptions<LAnnotation>): Promise<string> {\n  if (fileDiff == null && oldFile != null && newFile != null) {\n    fileDiff = parseDiffFromFile(oldFile, newFile);\n  }\n  if (fileDiff == null) {\n    throw new Error(\n      'preloadFileDiff: You must pass at least a fileDiff prop or oldFile/newFile props'\n    );\n  }\n  const diffHunksRenderer = new DiffHunksRenderer<LAnnotation>({\n    ...options,\n    hunkSeparators:\n      typeof options?.hunkSeparators === 'function'\n        ? 'custom'\n        : options?.hunkSeparators,\n  });\n\n  // Set line annotations if provided\n  if (annotations !== undefined && annotations.length > 0) {\n    diffHunksRenderer.setLineAnnotations(annotations);\n  }\n\n  const hunkResult = await diffHunksRenderer.asyncRender(fileDiff);\n\n  const children = [createStyleElement(hunkResult.css, true)];\n\n  if (options?.unsafeCSS != null) {\n    children.push(createStyleElement(options.unsafeCSS));\n  }\n\n  if (hunkResult.headerElement != null) {\n    children.push(hunkResult.headerElement);\n  }\n  const code = diffHunksRenderer.renderFullAST(hunkResult);\n  code.properties['data-dehydrated'] = '';\n  children.push(code);\n\n  return renderHTML(children);\n}\n\nexport interface PreloadMultiFileDiffOptions<LAnnotation> {\n  oldFile: FileContents;\n  newFile: FileContents;\n  options?: FileDiffOptions<LAnnotation>;\n  annotations?: DiffLineAnnotation<LAnnotation>[];\n}\n\nexport interface PreloadMultiFileDiffResult<LAnnotation> {\n  oldFile: FileContents;\n  newFile: FileContents;\n  options?: FileDiffOptions<LAnnotation>;\n  annotations?: DiffLineAnnotation<LAnnotation>[];\n  prerenderedHTML: string;\n}\n\nexport async function preloadMultiFileDiff<LAnnotation = undefined>({\n  oldFile,\n  newFile,\n  options,\n  annotations,\n}: PreloadMultiFileDiffOptions<LAnnotation>): Promise<\n  PreloadMultiFileDiffResult<LAnnotation>\n> {\n  return {\n    newFile,\n    oldFile,\n    options,\n    annotations,\n    prerenderedHTML: await preloadDiffHTML({\n      oldFile,\n      newFile,\n      options,\n      annotations,\n    }),\n  };\n}\n\nexport interface PreloadFileDiffOptions<LAnnotation> {\n  fileDiff: FileDiffMetadata;\n  options?: FileDiffOptions<LAnnotation>;\n  annotations?: DiffLineAnnotation<LAnnotation>[];\n}\n\nexport interface PreloadFileDiffResult<LAnnotation> {\n  fileDiff: FileDiffMetadata;\n  options?: FileDiffOptions<LAnnotation>;\n  annotations?: DiffLineAnnotation<LAnnotation>[];\n  prerenderedHTML: string;\n}\n\nexport async function preloadFileDiff<LAnnotation = undefined>({\n  fileDiff,\n  options,\n  annotations,\n}: PreloadFileDiffOptions<LAnnotation>): Promise<\n  PreloadFileDiffResult<LAnnotation>\n> {\n  return {\n    fileDiff,\n    options,\n    annotations,\n    prerenderedHTML: await preloadDiffHTML({\n      fileDiff,\n      options,\n      annotations,\n    }),\n  };\n}\n\nexport interface PreloadPatchDiffOptions<LAnnotation> {\n  patch: string;\n  options?: FileDiffOptions<LAnnotation>;\n  annotations?: DiffLineAnnotation<LAnnotation>[];\n}\n\nexport interface PreloadPatchDiffResult<LAnnotation> {\n  patch: string;\n  options?: FileDiffOptions<LAnnotation>;\n  annotations?: DiffLineAnnotation<LAnnotation>[];\n  prerenderedHTML: string;\n}\n\nexport async function preloadPatchDiff<LAnnotation = undefined>({\n  patch,\n  options,\n  annotations,\n}: PreloadPatchDiffOptions<LAnnotation>): Promise<\n  PreloadPatchDiffResult<LAnnotation>\n> {\n  const fileDiff = getSingularPatch(patch);\n  return {\n    patch,\n    options,\n    annotations,\n    prerenderedHTML: await preloadDiffHTML({\n      fileDiff,\n      options,\n      annotations,\n    }),\n  };\n}\n"],"mappings":";;;;;;;AAoBA,eAAsB,gBAAyC,EAC7D,UACA,SACA,SACA,SACA,eACmD;AACnD,KAAI,YAAY,QAAQ,WAAW,QAAQ,WAAW,KACpD,YAAW,kBAAkB,SAAS,QAAQ;AAEhD,KAAI,YAAY,KACd,OAAM,IAAI,MACR,mFACD;CAEH,MAAM,oBAAoB,IAAI,kBAA+B;EAC3D,GAAG;EACH,gBACE,OAAO,SAAS,mBAAmB,aAC/B,WACA,SAAS;EAChB,CAAC;AAGF,KAAI,gBAAgB,UAAa,YAAY,SAAS,EACpD,mBAAkB,mBAAmB,YAAY;CAGnD,MAAM,aAAa,MAAM,kBAAkB,YAAY,SAAS;CAEhE,MAAM,WAAW,CAAC,mBAAmB,WAAW,KAAK,KAAK,CAAC;AAE3D,KAAI,SAAS,aAAa,KACxB,UAAS,KAAK,mBAAmB,QAAQ,UAAU,CAAC;AAGtD,KAAI,WAAW,iBAAiB,KAC9B,UAAS,KAAK,WAAW,cAAc;CAEzC,MAAM,OAAO,kBAAkB,cAAc,WAAW;AACxD,MAAK,WAAW,qBAAqB;AACrC,UAAS,KAAK,KAAK;AAEnB,QAAO,WAAW,SAAS;;AAkB7B,eAAsB,qBAA8C,EAClE,SACA,SACA,SACA,eAGA;AACA,QAAO;EACL;EACA;EACA;EACA;EACA,iBAAiB,MAAM,gBAAgB;GACrC;GACA;GACA;GACA;GACD,CAAC;EACH;;AAgBH,eAAsB,gBAAyC,EAC7D,UACA,SACA,eAGA;AACA,QAAO;EACL;EACA;EACA;EACA,iBAAiB,MAAM,gBAAgB;GACrC;GACA;GACA;GACD,CAAC;EACH;;AAgBH,eAAsB,iBAA0C,EAC9D,OACA,SACA,eAGA;AAEA,QAAO;EACL;EACA;EACA;EACA,iBAAiB,MAAM,gBAAgB;GACrC,UANa,iBAAiB,MAAM;GAOpC;GACA;GACD,CAAC;EACH"}