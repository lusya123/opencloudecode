{"version":3,"file":"FileRenderer.js","names":["options: FileRendererOptions","onRenderUpdate?: () => unknown","workerManager?: WorkerPoolManager | undefined","options","options: RenderFileOptions","codeAST: ElementContent[]"],"sources":["../../src/renderers/FileRenderer.ts"],"sourcesContent":["import type { ElementContent, Element as HASTElement } from 'hast';\nimport { toHtml } from 'hast-util-to-html';\n\nimport { DEFAULT_THEMES } from '../constants';\nimport { areLanguagesAttached } from '../highlighter/languages/areLanguagesAttached';\nimport {\n  getHighlighterIfLoaded,\n  getSharedHighlighter,\n} from '../highlighter/shared_highlighter';\nimport { areThemesAttached } from '../highlighter/themes/areThemesAttached';\nimport { hasResolvedThemes } from '../highlighter/themes/hasResolvedThemes';\nimport type {\n  BaseCodeOptions,\n  DiffsHighlighter,\n  FileContents,\n  LineAnnotation,\n  RenderFileOptions,\n  RenderFileResult,\n  RenderedFileASTCache,\n  SupportedLanguages,\n  ThemeTypes,\n  ThemedFileResult,\n} from '../types';\nimport { areThemesEqual } from '../utils/areThemesEqual';\nimport { createAnnotationElement } from '../utils/createAnnotationElement';\nimport { createFileHeaderElement } from '../utils/createFileHeaderElement';\nimport { createPreElement } from '../utils/createPreElement';\nimport { getFiletypeFromFileName } from '../utils/getFiletypeFromFileName';\nimport { getHighlighterOptions } from '../utils/getHighlighterOptions';\nimport { getLineAnnotationName } from '../utils/getLineAnnotationName';\nimport { getThemes } from '../utils/getThemes';\nimport { createHastElement } from '../utils/hast_utils';\nimport { renderFileWithHighlighter } from '../utils/renderFileWithHighlighter';\nimport type { WorkerPoolManager } from '../worker';\n\ntype AnnotationLineMap<LAnnotation> = Record<\n  number,\n  LineAnnotation<LAnnotation>[] | undefined\n>;\n\ninterface GetRenderOptionsReturn {\n  options: RenderFileOptions;\n  forceRender: boolean;\n}\n\nexport interface FileRenderResult {\n  codeAST: ElementContent[];\n  preAST: HASTElement;\n  headerAST: HASTElement | undefined;\n  css: string;\n  totalLines: number;\n  themeStyles: string;\n  baseThemeType: 'light' | 'dark' | undefined;\n}\n\n// eslint-disable-next-line @typescript-eslint/no-empty-object-type\nexport interface FileRendererOptions extends BaseCodeOptions {}\n\nexport class FileRenderer<LAnnotation = undefined> {\n  private highlighter: DiffsHighlighter | undefined;\n  private renderCache: RenderedFileASTCache | undefined;\n  private computedLang: SupportedLanguages = 'text';\n  private lineAnnotations: AnnotationLineMap<LAnnotation> = {};\n\n  constructor(\n    public options: FileRendererOptions = { theme: DEFAULT_THEMES },\n    private onRenderUpdate?: () => unknown,\n    private workerManager?: WorkerPoolManager | undefined\n  ) {\n    if (workerManager?.isWorkingPool() !== true) {\n      this.highlighter = areThemesAttached(options.theme ?? DEFAULT_THEMES)\n        ? getHighlighterIfLoaded()\n        : undefined;\n    }\n  }\n\n  setOptions(options: FileRendererOptions): void {\n    this.options = options;\n  }\n\n  private mergeOptions(options: Partial<FileRendererOptions>): void {\n    this.options = { ...this.options, ...options };\n  }\n\n  setThemeType(themeType: ThemeTypes): void {\n    const currentThemeType = this.options.themeType ?? 'system';\n    if (currentThemeType === themeType) {\n      return;\n    }\n    this.mergeOptions({ themeType });\n  }\n\n  setLineAnnotations(lineAnnotations: LineAnnotation<LAnnotation>[]): void {\n    this.lineAnnotations = {};\n    for (const annotation of lineAnnotations) {\n      const arr = this.lineAnnotations[annotation.lineNumber] ?? [];\n      this.lineAnnotations[annotation.lineNumber] = arr;\n      arr.push(annotation);\n    }\n  }\n\n  cleanUp(): void {\n    this.renderCache = undefined;\n    this.highlighter = undefined;\n    this.workerManager = undefined;\n    this.onRenderUpdate = undefined;\n  }\n\n  hydrate(file: FileContents): void {\n    const { options } = this.getRenderOptions(file);\n    let cache = this.workerManager?.getFileResultCache(file);\n    if (cache != null && !areRenderOptionsEqual(options, cache.options)) {\n      cache = undefined;\n    }\n    this.renderCache ??= {\n      file,\n      options,\n      // NOTE(amadeus): If we're hydrating, we can assume there was\n      // pre-rendered HTML, otherwise one should not be hydrating\n      highlighted: true,\n      result: cache?.result,\n    };\n    if (\n      this.workerManager?.isWorkingPool() === true &&\n      this.renderCache.result == null\n    ) {\n      this.workerManager.highlightFileAST(this, file);\n    } else {\n      void this.asyncHighlight(file).then(({ result, options }) => {\n        this.onHighlightSuccess(file, result, options);\n      });\n    }\n  }\n\n  private getRenderOptions(file: FileContents): GetRenderOptionsReturn {\n    const options: RenderFileOptions = (() => {\n      if (this.workerManager?.isWorkingPool() === true) {\n        return this.workerManager.getFileRenderOptions();\n      }\n      const { theme = DEFAULT_THEMES, tokenizeMaxLineLength = 1000 } =\n        this.options;\n      return { theme, tokenizeMaxLineLength };\n    })();\n    const { renderCache } = this;\n    if (renderCache?.result == null) {\n      return { options, forceRender: true };\n    }\n    if (\n      file !== renderCache.file ||\n      !areRenderOptionsEqual(options, renderCache.options)\n    ) {\n      return { options, forceRender: true };\n    }\n    return { options, forceRender: false };\n  }\n\n  renderFile(\n    file: FileContents | undefined = this.renderCache?.file\n  ): FileRenderResult | undefined {\n    if (file == null) {\n      return undefined;\n    }\n    const cache = this.workerManager?.getFileResultCache(file);\n    if (cache != null && this.renderCache == null) {\n      this.renderCache = { file, highlighted: true, ...cache };\n    }\n    const { options, forceRender } = this.getRenderOptions(file);\n    this.renderCache ??= {\n      file,\n      highlighted: false,\n      options,\n      result: undefined,\n    };\n    if (this.workerManager?.isWorkingPool() === true) {\n      this.renderCache.result ??= this.workerManager.getPlainFileAST(file);\n      // TODO(amadeus): Figure out how to only fire this on a per file\n      // basis... (maybe the poolManager can figure it out based on file name\n      // and file contents probably?)\n      if (!this.renderCache.highlighted || forceRender) {\n        this.workerManager.highlightFileAST(this, file);\n      }\n    } else {\n      this.computedLang = file.lang ?? getFiletypeFromFileName(file.name);\n      const hasThemes =\n        this.highlighter != null && areThemesAttached(options.theme);\n      const hasLangs =\n        this.highlighter != null && areLanguagesAttached(this.computedLang);\n\n      // If we have any semblance of a highlighter with the correct theme(s)\n      // attached, we can kick off some form of rendering.  If we don't have\n      // the correct language, then we can render plain text and after kick off\n      // an async job to get the highlighted AST\n      if (\n        this.highlighter != null &&\n        hasThemes &&\n        (forceRender ||\n          (!this.renderCache.highlighted && hasLangs) ||\n          this.renderCache.result == null)\n      ) {\n        const { result, options } = this.renderFileWithHighlighter(\n          file,\n          this.highlighter,\n          !hasLangs\n        );\n        this.renderCache = {\n          file,\n          options,\n          highlighted: hasLangs,\n          result,\n        };\n      }\n\n      // If we get in here it means we'll have to kick off an async highlight\n      // process which will involve initializing the highlighter with new themes\n      // and languages\n      if (!hasThemes || !hasLangs) {\n        void this.asyncHighlight(file).then(({ result, options }) => {\n          this.onHighlightSuccess(file, result, options);\n        });\n      }\n    }\n\n    return this.renderCache.result != null\n      ? this.processFileResult(this.renderCache.file, this.renderCache.result)\n      : undefined;\n  }\n\n  async asyncRender(file: FileContents): Promise<FileRenderResult> {\n    const { result } = await this.asyncHighlight(file);\n    return this.processFileResult(file, result);\n  }\n\n  private async asyncHighlight(file: FileContents): Promise<RenderFileResult> {\n    this.computedLang = file.lang ?? getFiletypeFromFileName(file.name);\n    const hasThemes =\n      this.highlighter != null &&\n      hasResolvedThemes(getThemes(this.options.theme));\n    const hasLangs =\n      this.highlighter != null && areLanguagesAttached(this.computedLang);\n    // If we don't have the required langs or themes, then we need to\n    // initialize the highlighter to load the appropriate languages and themes\n    if (this.highlighter == null || !hasThemes || !hasLangs) {\n      this.highlighter = await this.initializeHighlighter();\n    }\n    return this.renderFileWithHighlighter(file, this.highlighter);\n  }\n\n  private renderFileWithHighlighter(\n    file: FileContents,\n    highlighter: DiffsHighlighter,\n    plainText = false\n  ): RenderFileResult {\n    const { options } = this.getRenderOptions(file);\n    const result = renderFileWithHighlighter(\n      file,\n      highlighter,\n      options,\n      plainText\n    );\n    return { result, options };\n  }\n\n  private processFileResult(\n    file: FileContents,\n    result: ThemedFileResult\n  ): FileRenderResult {\n    const { disableFileHeader = false } = this.options;\n    const codeAST: ElementContent[] = [];\n    let lineIndex = 1;\n    for (const line of result.code) {\n      codeAST.push(line);\n      const annotations = this.lineAnnotations[lineIndex];\n      if (annotations != null) {\n        codeAST.push(\n          createAnnotationElement({\n            type: 'annotation',\n            hunkIndex: 0,\n            lineIndex,\n            annotations: annotations.map((annotation) =>\n              getLineAnnotationName(annotation)\n            ),\n          })\n        );\n      }\n      lineIndex++;\n    }\n\n    return {\n      codeAST,\n      preAST: this.createPreElement(\n        result.code.length,\n        result.themeStyles,\n        result.baseThemeType\n      ),\n      headerAST: !disableFileHeader\n        ? this.renderHeader(file, result.themeStyles, result.baseThemeType)\n        : undefined,\n      totalLines: result.code.length,\n      themeStyles: result.themeStyles,\n      baseThemeType: result.baseThemeType,\n      // FIXME(amadeus): Fix this\n      css: '',\n    };\n  }\n\n  private renderHeader(\n    file: FileContents,\n    themeStyles: string,\n    baseThemeType: 'light' | 'dark' | undefined\n  ) {\n    const { themeType = 'system' } = this.options;\n    return createFileHeaderElement({\n      fileOrDiff: file,\n      themeStyles,\n      themeType: baseThemeType ?? themeType,\n    });\n  }\n\n  renderFullHTML(result: FileRenderResult): string {\n    return toHtml(this.renderFullAST(result));\n  }\n\n  renderFullAST(\n    result: FileRenderResult,\n    children: ElementContent[] = []\n  ): HASTElement {\n    children.push(\n      createHastElement({\n        tagName: 'code',\n        children: result.codeAST,\n        properties: { 'data-code': '' },\n      })\n    );\n    return { ...result.preAST, children };\n  }\n\n  renderPartialHTML(\n    children: ElementContent[],\n    includeCodeNode: boolean = false\n  ): string {\n    if (!includeCodeNode) {\n      return toHtml(children);\n    }\n    return toHtml(\n      createHastElement({\n        tagName: 'code',\n        children,\n        properties: { 'data-code': '' },\n      })\n    );\n  }\n\n  async initializeHighlighter(): Promise<DiffsHighlighter> {\n    this.highlighter = await getSharedHighlighter(\n      getHighlighterOptions(this.computedLang, this.options)\n    );\n    return this.highlighter;\n  }\n\n  onHighlightSuccess(\n    file: FileContents,\n    result: ThemedFileResult,\n    options: RenderFileOptions\n  ): void {\n    if (this.renderCache == null) {\n      return;\n    }\n    const triggerRenderUpdate =\n      this.renderCache.file !== file ||\n      !this.renderCache.highlighted ||\n      !areRenderOptionsEqual(options, this.renderCache.options);\n\n    this.renderCache = {\n      file,\n      options,\n      highlighted: true,\n      result,\n    };\n\n    if (triggerRenderUpdate) {\n      this.onRenderUpdate?.();\n    }\n  }\n\n  onHighlightError(error: unknown): void {\n    console.error(error);\n  }\n\n  private createPreElement(\n    totalLines: number,\n    themeStyles: string,\n    baseThemeType: 'light' | 'dark' | undefined\n  ): HASTElement {\n    const {\n      disableLineNumbers = false,\n      overflow = 'scroll',\n      themeType = 'system',\n    } = this.options;\n    return createPreElement({\n      diffIndicators: 'none',\n      disableBackground: true,\n      disableLineNumbers,\n      overflow,\n      themeStyles,\n      themeType: baseThemeType ?? themeType,\n      split: false,\n      totalLines,\n    });\n  }\n}\n\nfunction areRenderOptionsEqual(\n  optionsA: RenderFileOptions,\n  optionsB: RenderFileOptions\n): boolean {\n  return (\n    areThemesEqual(optionsA.theme, optionsB.theme) &&\n    optionsA.tokenizeMaxLineLength === optionsB.tokenizeMaxLineLength\n  );\n}\n"],"mappings":"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"}