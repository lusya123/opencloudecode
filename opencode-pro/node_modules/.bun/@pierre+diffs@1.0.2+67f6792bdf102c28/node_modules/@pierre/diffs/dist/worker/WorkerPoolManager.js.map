{"version":3,"file":"WorkerPoolManager.js","names":["options: WorkerPoolOptions","newRenderOptions: WorkerRenderingOptions","resolvedThemes: ThemeRegistrationResolved[]","taskPromises: Promise<void>[]","task: SetRenderOptionsWorkerTask","resolvedLanguages: ResolvedLanguage[]","initPromises: Promise<unknown>[]","managedWorker: ManagedWorker","task: InitializeWorkerTask","task: RenderFileTask | RenderDiffTask","worker: ManagedWorker | undefined"],"sources":["../../src/worker/WorkerPoolManager.ts"],"sourcesContent":["import { LRUMap } from 'lru_map';\n\nimport { DEFAULT_THEMES } from '../constants';\nimport { getResolvedLanguages } from '../highlighter/languages/getResolvedLanguages';\nimport { hasResolvedLanguages } from '../highlighter/languages/hasResolvedLanguages';\nimport { resolveLanguages } from '../highlighter/languages/resolveLanguages';\nimport { getSharedHighlighter } from '../highlighter/shared_highlighter';\nimport { attachResolvedThemes } from '../highlighter/themes/attachResolvedThemes';\nimport { getResolvedThemes } from '../highlighter/themes/getResolvedThemes';\nimport { hasResolvedThemes } from '../highlighter/themes/hasResolvedThemes';\nimport { resolveThemes } from '../highlighter/themes/resolveThemes';\nimport type {\n  DiffsHighlighter,\n  FileContents,\n  FileDiffMetadata,\n  RenderDiffOptions,\n  RenderDiffResult,\n  RenderFileOptions,\n  RenderFileResult,\n  SupportedLanguages,\n  ThemeRegistrationResolved,\n  ThemedDiffResult,\n  ThemedFileResult,\n} from '../types';\nimport { areThemesEqual } from '../utils/areThemesEqual';\nimport { getFiletypeFromFileName } from '../utils/getFiletypeFromFileName';\nimport { getThemes } from '../utils/getThemes';\nimport { renderDiffWithHighlighter } from '../utils/renderDiffWithHighlighter';\nimport { renderFileWithHighlighter } from '../utils/renderFileWithHighlighter';\nimport type {\n  AllWorkerTasks,\n  DiffRendererInstance,\n  FileRendererInstance,\n  InitializeWorkerTask,\n  RenderDiffRequest,\n  RenderDiffTask,\n  RenderFileRequest,\n  RenderFileTask,\n  ResolvedLanguage,\n  SetRenderOptionsWorkerTask,\n  SubmitRequest,\n  WorkerInitializationRenderOptions,\n  WorkerPoolOptions,\n  WorkerRenderingOptions,\n  WorkerRequestId,\n  WorkerResponse,\n  WorkerStats,\n} from './types';\n\nconst IGNORE_RESPONSE = Symbol('IGNORE_RESPONSE');\n\ninterface GetCachesResult {\n  fileCache: LRUMap<string, RenderFileResult>;\n  diffCache: LRUMap<string, RenderDiffResult>;\n}\n\ninterface ManagedWorker {\n  worker: Worker;\n  busy: boolean;\n  initialized: boolean;\n  langs: Set<SupportedLanguages>;\n}\n\ninterface ThemeSubscriber {\n  rerender(): void;\n}\n\nexport class WorkerPoolManager {\n  private highlighter: DiffsHighlighter | undefined;\n  private renderOptions: WorkerRenderingOptions;\n  private initialized: Promise<void> | boolean = false;\n  private workers: ManagedWorker[] = [];\n  private taskQueue: AllWorkerTasks[] = [];\n  private pendingTasks = new Map<WorkerRequestId, AllWorkerTasks>();\n  private nextRequestId = 0;\n  private themeSubscribers = new Set<ThemeSubscriber>();\n  private workersFailed = false;\n  private instanceRequestMap = new Map<\n    FileRendererInstance | DiffRendererInstance,\n    string\n  >();\n  private fileCache: LRUMap<string, RenderFileResult>;\n  private diffCache: LRUMap<string, RenderDiffResult>;\n\n  constructor(\n    private options: WorkerPoolOptions,\n    {\n      langs,\n      theme = DEFAULT_THEMES,\n      lineDiffType = 'word-alt',\n      tokenizeMaxLineLength = 1000,\n    }: WorkerInitializationRenderOptions\n  ) {\n    this.renderOptions = { theme, lineDiffType, tokenizeMaxLineLength };\n    this.fileCache = new LRUMap(options.totalASTLRUCacheSize ?? 100);\n    this.diffCache = new LRUMap(options.totalASTLRUCacheSize ?? 100);\n    void this.initialize(langs);\n  }\n\n  isWorkingPool(): boolean {\n    return !this.workersFailed;\n  }\n\n  getFileResultCache(file: FileContents): RenderFileResult | undefined {\n    return file.cacheKey != null\n      ? this.fileCache.get(file.cacheKey)\n      : undefined;\n  }\n\n  getDiffResultCache(diff: FileDiffMetadata): RenderDiffResult | undefined {\n    return diff.cacheKey != null\n      ? this.diffCache.get(diff.cacheKey)\n      : undefined;\n  }\n\n  inspectCaches(): GetCachesResult {\n    const { fileCache, diffCache } = this;\n    return { fileCache, diffCache };\n  }\n\n  evictFileFromCache(cacheKey: string): boolean {\n    return this.fileCache.delete(cacheKey) !== undefined;\n  }\n\n  evictDiffFromCache(cacheKey: string): boolean {\n    return this.diffCache.delete(cacheKey) !== undefined;\n  }\n\n  async setRenderOptions({\n    theme = DEFAULT_THEMES,\n    lineDiffType = 'word-alt',\n    tokenizeMaxLineLength = 1000,\n  }: Partial<WorkerRenderingOptions>): Promise<void> {\n    const newRenderOptions: WorkerRenderingOptions = {\n      theme,\n      lineDiffType,\n      tokenizeMaxLineLength,\n    };\n    if (!this.isInitialized()) {\n      await this.initialize();\n    }\n    const themesEqual = areThemesEqual(\n      newRenderOptions.theme,\n      this.renderOptions.theme\n    );\n    if (\n      themesEqual &&\n      newRenderOptions.lineDiffType === this.renderOptions.lineDiffType &&\n      newRenderOptions.tokenizeMaxLineLength ===\n        this.renderOptions.tokenizeMaxLineLength\n    ) {\n      return;\n    }\n\n    const themeNames = getThemes(theme);\n    let resolvedThemes: ThemeRegistrationResolved[] = [];\n    if (!themesEqual) {\n      if (hasResolvedThemes(themeNames)) {\n        resolvedThemes = getResolvedThemes(themeNames);\n      } else {\n        resolvedThemes = await resolveThemes(themeNames);\n      }\n    }\n\n    if (this.highlighter != null) {\n      attachResolvedThemes(resolvedThemes, this.highlighter);\n      await this.setRenderOptionsOnWorkers(newRenderOptions, resolvedThemes);\n    } else {\n      const [highlighter] = await Promise.all([\n        getSharedHighlighter({ themes: themeNames, langs: ['text'] }),\n        this.setRenderOptionsOnWorkers(newRenderOptions, resolvedThemes),\n      ]);\n      this.highlighter = highlighter;\n    }\n\n    this.renderOptions = newRenderOptions;\n    this.diffCache.clear();\n    this.fileCache.clear();\n\n    for (const instance of this.themeSubscribers) {\n      instance.rerender();\n    }\n  }\n\n  getFileRenderOptions(): RenderFileOptions {\n    const { tokenizeMaxLineLength, theme } = this.renderOptions;\n    return { theme, tokenizeMaxLineLength };\n  }\n\n  getDiffRenderOptions(): RenderDiffOptions {\n    return { ...this.renderOptions };\n  }\n\n  private async setRenderOptionsOnWorkers(\n    renderOptions: WorkerRenderingOptions,\n    resolvedThemes: ThemeRegistrationResolved[]\n  ): Promise<void> {\n    if (this.workersFailed) {\n      return;\n    }\n    if (!this.isInitialized()) {\n      await this.initialize();\n    }\n    const taskPromises: Promise<void>[] = [];\n    for (const managedWorker of this.workers) {\n      if (!managedWorker.initialized) {\n        console.log({ managedWorker });\n        throw new Error(\n          'setRenderOptionsOnWorkers: Somehow we have an uninitialized worker'\n        );\n      }\n      taskPromises.push(\n        new Promise<void>((resolve, reject) => {\n          const id = this.generateRequestId();\n          const task: SetRenderOptionsWorkerTask = {\n            type: 'set-render-options',\n            id,\n            request: {\n              type: 'set-render-options',\n              id,\n              renderOptions,\n              resolvedThemes,\n            },\n            resolve,\n            reject,\n            requestStart: Date.now(),\n          };\n          this.pendingTasks.set(id, task);\n          managedWorker.worker.postMessage(task.request);\n        })\n      );\n    }\n    await Promise.all(taskPromises);\n  }\n\n  subscribeToThemeChanges(instance: ThemeSubscriber): () => void {\n    this.themeSubscribers.add(instance);\n    return () => {\n      this.unsubscribeToThemeChanges(instance);\n    };\n  }\n\n  unsubscribeToThemeChanges(instance: ThemeSubscriber): void {\n    this.themeSubscribers.delete(instance);\n  }\n\n  isInitialized(): boolean {\n    return this.initialized === true;\n  }\n\n  async initialize(languages: SupportedLanguages[] = []): Promise<void> {\n    if (this.initialized === true) {\n      return;\n    } else if (this.initialized === false) {\n      this.initialized = new Promise((resolve, reject) => {\n        void (async () => {\n          try {\n            const themes = getThemes(this.renderOptions.theme);\n            let resolvedThemes: ThemeRegistrationResolved[] = [];\n            if (hasResolvedThemes(themes)) {\n              resolvedThemes = getResolvedThemes(themes);\n            } else {\n              resolvedThemes = await resolveThemes(themes);\n            }\n\n            let resolvedLanguages: ResolvedLanguage[] = [];\n            if (hasResolvedLanguages(languages)) {\n              resolvedLanguages = getResolvedLanguages(languages);\n            } else {\n              resolvedLanguages = await resolveLanguages(languages);\n            }\n\n            const [highlighter] = await Promise.all([\n              getSharedHighlighter({ themes, langs: ['text', ...languages] }),\n              this.initializeWorkers(resolvedThemes, resolvedLanguages),\n            ]);\n\n            // If we were terminated while initializing, we should probably kill\n            // any workers that may have been created\n            if (this.initialized === false) {\n              this.terminateWorkers();\n              reject();\n              return;\n            }\n            this.highlighter = highlighter;\n            this.initialized = true;\n            this.diffCache.clear();\n            this.fileCache.clear();\n            this.drainQueue();\n            resolve();\n          } catch (e) {\n            this.initialized = false;\n            this.workersFailed = true;\n            reject(e);\n          }\n        })();\n      });\n    } else {\n      return this.initialized;\n    }\n  }\n\n  private async initializeWorkers(\n    resolvedThemes: ThemeRegistrationResolved[],\n    resolvedLanguages: ResolvedLanguage[]\n  ): Promise<void> {\n    this.workersFailed = false;\n    const initPromises: Promise<unknown>[] = [];\n    if (this.workers.length > 0) {\n      this.terminateWorkers();\n    }\n    for (let i = 0; i < (this.options.poolSize ?? 8); i++) {\n      const worker = this.options.workerFactory();\n      const managedWorker: ManagedWorker = {\n        worker,\n        busy: false,\n        initialized: false,\n        langs: new Set(['text', ...resolvedLanguages.map(({ name }) => name)]),\n      };\n      worker.addEventListener(\n        'message',\n        (event: MessageEvent<WorkerResponse>) => {\n          this.handleWorkerMessage(managedWorker, event.data);\n        }\n      );\n      worker.addEventListener('error', (error) =>\n        console.error('Worker error:', error, managedWorker)\n      );\n      this.workers.push(managedWorker);\n      initPromises.push(\n        new Promise<void>((resolve, reject) => {\n          const id = this.generateRequestId();\n          const task: InitializeWorkerTask = {\n            type: 'initialize',\n            id,\n            request: {\n              type: 'initialize',\n              id,\n              renderOptions: this.renderOptions,\n              resolvedThemes,\n              resolvedLanguages,\n            },\n            resolve() {\n              managedWorker.initialized = true;\n              resolve();\n            },\n            reject,\n            requestStart: Date.now(),\n          };\n          this.pendingTasks.set(id, task);\n          this.executeTask(managedWorker, task);\n        })\n      );\n    }\n    await Promise.all(initPromises);\n  }\n\n  private drainQueue = () => {\n    this._queuedDrain = undefined;\n    // If we are initializing or things got cancelled while initializing, we\n    // should not attempt to drain the queue\n    if (this.initialized !== true || this.taskQueue.length === 0) {\n      return;\n    }\n    while (this.taskQueue.length > 0) {\n      const task = this.taskQueue[0];\n      const langs = getLangsFromTask(task);\n      const availableWorker = this.getAvailableWorker(langs);\n      if (availableWorker == null) {\n        break;\n      }\n      this.taskQueue.shift();\n      void this.resolveLanguagesAndExecuteTask(availableWorker, task, langs);\n    }\n  };\n\n  highlightFileAST(instance: FileRendererInstance, file: FileContents): void {\n    this.submitTask(instance, { type: 'file', file });\n  }\n\n  getPlainFileAST(file: FileContents): ThemedFileResult | undefined {\n    if (this.highlighter == null) {\n      void this.initialize();\n      return undefined;\n    }\n    return renderFileWithHighlighter(\n      file,\n      this.highlighter,\n      this.renderOptions,\n      true\n    );\n  }\n\n  highlightDiffAST(\n    instance: DiffRendererInstance,\n    diff: FileDiffMetadata\n  ): void {\n    this.submitTask(instance, { type: 'diff', diff });\n  }\n\n  getPlainDiffAST(diff: FileDiffMetadata): ThemedDiffResult | undefined {\n    return this.highlighter != null\n      ? renderDiffWithHighlighter(\n          diff,\n          this.highlighter,\n          this.renderOptions,\n          true\n        )\n      : undefined;\n  }\n\n  terminate(): void {\n    this.terminateWorkers();\n    this.fileCache.clear();\n    this.diffCache.clear();\n    this.instanceRequestMap.clear();\n    this.taskQueue.length = 0;\n    this.pendingTasks.clear();\n    this.highlighter = undefined;\n    this.initialized = false;\n    this.workersFailed = false;\n  }\n\n  private terminateWorkers() {\n    for (const managedWorker of this.workers) {\n      managedWorker.worker.terminate();\n    }\n    this.workers.length = 0;\n  }\n\n  getStats(): WorkerStats {\n    return {\n      totalWorkers: this.workers.length,\n      busyWorkers: this.workers.filter((w) => w.busy).length,\n      queuedTasks: this.taskQueue.length,\n      pendingTasks: this.pendingTasks.size,\n    };\n  }\n\n  private submitTask(\n    instance: FileRendererInstance,\n    request: Omit<RenderFileRequest, 'id'>\n  ): void;\n  private submitTask(\n    instance: DiffRendererInstance,\n    request: Omit<RenderDiffRequest, 'id'>\n  ): void;\n  private submitTask(\n    instance: FileRendererInstance | DiffRendererInstance,\n    request: SubmitRequest\n  ): void {\n    if (this.initialized === false) {\n      void this.initialize();\n    }\n\n    const id = this.generateRequestId();\n    const requestStart = Date.now();\n    const task: RenderFileTask | RenderDiffTask = (() => {\n      switch (request.type) {\n        case 'file':\n          return {\n            type: 'file',\n            id,\n            request: { ...request, id },\n            instance: instance as FileRendererInstance,\n            requestStart,\n          };\n        case 'diff':\n          return {\n            type: 'diff',\n            id,\n            request: { ...request, id },\n            instance: instance as DiffRendererInstance,\n            requestStart,\n          };\n      }\n    })();\n\n    this.instanceRequestMap.set(instance, id);\n    this.taskQueue.push(task);\n    this.queueDrain();\n  }\n\n  private async resolveLanguagesAndExecuteTask(\n    availableWorker: ManagedWorker,\n    task: AllWorkerTasks,\n    langs: SupportedLanguages[]\n  ): Promise<void> {\n    // Add resolved languages if required\n    if (task.type === 'file' || task.type === 'diff') {\n      const workerMissingLangs = langs.filter(\n        (lang) => !availableWorker.langs.has(lang)\n      );\n\n      if (workerMissingLangs.length > 0) {\n        if (hasResolvedLanguages(workerMissingLangs)) {\n          task.request.resolvedLanguages =\n            getResolvedLanguages(workerMissingLangs);\n        } else {\n          task.request.resolvedLanguages =\n            await resolveLanguages(workerMissingLangs);\n        }\n      }\n    }\n    this.executeTask(availableWorker, task);\n  }\n\n  private handleWorkerMessage(\n    managedWorker: ManagedWorker,\n    response: WorkerResponse\n  ): void {\n    const task = this.pendingTasks.get(response.id);\n    try {\n      if (task == null) {\n        throw new Error(\n          'handleWorkerMessage: Received response for unknown task'\n        );\n      } else if (response.type === 'error') {\n        const error = new Error(response.error);\n        if (response.stack) {\n          error.stack = response.stack;\n        }\n        if ('reject' in task) {\n          task.reject(error);\n        } else {\n          task.instance.onHighlightError(error);\n        }\n        throw error;\n      } else {\n        // If we've gotten a newer request from the same instance, we should\n        // ignore this response either because it's out of order or because we\n        // have a newer more important request\n        if (\n          'instance' in task &&\n          this.instanceRequestMap.get(task.instance) !== response.id\n        ) {\n          throw IGNORE_RESPONSE;\n        }\n        switch (response.requestType) {\n          case 'initialize':\n            if (task.type !== 'initialize') {\n              throw new Error('handleWorkerMessage: task/response dont match');\n            }\n            task.resolve();\n            break;\n          case 'set-render-options':\n            if (task.type !== 'set-render-options') {\n              throw new Error('handleWorkerMessage: task/response dont match');\n            }\n            task.resolve();\n            break;\n          case 'file': {\n            if (task.type !== 'file') {\n              throw new Error('handleWorkerMessage: task/response dont match');\n            }\n            const { result, options } = response;\n            const { instance, request } = task;\n            if (request.file.cacheKey != null) {\n              this.fileCache.set(request.file.cacheKey, { result, options });\n            }\n            instance.onHighlightSuccess(request.file, result, options);\n            break;\n          }\n          case 'diff': {\n            if (task.type !== 'diff') {\n              throw new Error('handleWorkerMessage: task/response dont match');\n            }\n            const { result, options } = response;\n            const { instance, request } = task;\n            if (request.diff.cacheKey != null) {\n              this.diffCache.set(request.diff.cacheKey, { result, options });\n            }\n            instance.onHighlightSuccess(request.diff, result, options);\n            break;\n          }\n        }\n      }\n    } catch (error) {\n      if (error !== IGNORE_RESPONSE) {\n        console.error(error, task, response);\n      }\n    }\n\n    if (\n      task != null &&\n      'instance' in task &&\n      this.instanceRequestMap.get(task.instance) === response.id\n    ) {\n      this.instanceRequestMap.delete(task.instance);\n    }\n    this.pendingTasks.delete(response.id);\n    managedWorker.busy = false;\n    if (this.taskQueue.length > 0) {\n      // We queue drain so that potentially multiple workers can free up\n      // allowing for better language matches if possible\n      this.queueDrain();\n    }\n  }\n\n  private _queuedDrain: Promise<void> | undefined;\n  private queueDrain() {\n    if (this._queuedDrain != null) return;\n    this._queuedDrain = Promise.resolve().then(this.drainQueue);\n  }\n\n  private executeTask(\n    managedWorker: ManagedWorker,\n    task: AllWorkerTasks\n  ): void {\n    managedWorker.busy = true;\n    this.pendingTasks.set(task.id, task);\n    for (const lang of getLangsFromTask(task)) {\n      managedWorker.langs.add(lang);\n    }\n    managedWorker.worker.postMessage(task.request);\n  }\n\n  private getAvailableWorker(\n    langs: SupportedLanguages[]\n  ): ManagedWorker | undefined {\n    let worker: ManagedWorker | undefined;\n    for (const managedWorker of this.workers) {\n      if (managedWorker.busy || !managedWorker.initialized) {\n        continue;\n      }\n      worker = managedWorker;\n      if (langs.length === 0) {\n        break;\n      }\n      let hasEveryLang = true;\n      for (const lang of langs) {\n        if (!managedWorker.langs.has(lang)) {\n          hasEveryLang = false;\n          break;\n        }\n      }\n      if (hasEveryLang) {\n        break;\n      }\n    }\n    return worker;\n  }\n\n  private generateRequestId(): WorkerRequestId {\n    return `req_${++this.nextRequestId}`;\n  }\n}\n\nfunction getLangsFromTask(task: AllWorkerTasks): SupportedLanguages[] {\n  const langs = new Set<SupportedLanguages>();\n  if (task.type === 'initialize' || task.type === 'set-render-options') {\n    return [];\n  }\n  switch (task.type) {\n    case 'file': {\n      langs.add(\n        task.request.file.lang ??\n          getFiletypeFromFileName(task.request.file.name)\n      );\n      break;\n    }\n    case 'diff': {\n      langs.add(\n        task.request.diff.lang ??\n          getFiletypeFromFileName(task.request.diff.name)\n      );\n      langs.add(\n        task.request.diff.lang ??\n          getFiletypeFromFileName(task.request.diff.prevName ?? '-')\n      );\n      break;\n    }\n  }\n  langs.delete('text');\n  return Array.from(langs);\n}\n"],"mappings":"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"}