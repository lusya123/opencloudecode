{"version":3,"file":"useFileInstance.js","names":[],"sources":["../../../src/react/utils/useFileInstance.ts"],"sourcesContent":["import {\n  useCallback,\n  useContext,\n  useEffect,\n  useLayoutEffect,\n  useRef,\n} from 'react';\n\nimport { File, type FileOptions } from '../../components/File';\nimport type { SelectedLineRange } from '../../managers/LineSelectionManager';\nimport type { GetHoveredLineResult } from '../../managers/MouseEventManager';\nimport type { FileContents, LineAnnotation } from '../../types';\nimport { areOptionsEqual } from '../../utils/areOptionsEqual';\nimport { WorkerPoolContext } from '../WorkerPoolContext';\nimport { useStableCallback } from './useStableCallback';\n\nconst useIsometricEffect =\n  typeof window === 'undefined' ? useEffect : useLayoutEffect;\n\ninterface UseFileInstanceProps<LAnnotation> {\n  file: FileContents;\n  options: FileOptions<LAnnotation> | undefined;\n  lineAnnotations: LineAnnotation<LAnnotation>[] | undefined;\n  selectedLines: SelectedLineRange | null | undefined;\n  prerenderedHTML: string | undefined;\n}\n\ninterface UseFileInstanceReturn {\n  ref(node: HTMLElement | null): void;\n  getHoveredLine(): GetHoveredLineResult<'file'> | undefined;\n}\n\nexport function useFileInstance<LAnnotation>({\n  file,\n  options,\n  lineAnnotations,\n  selectedLines,\n  prerenderedHTML,\n}: UseFileInstanceProps<LAnnotation>): UseFileInstanceReturn {\n  const poolManager = useContext(WorkerPoolContext);\n  const instanceRef = useRef<File<LAnnotation> | null>(null);\n  const ref = useStableCallback((node: HTMLElement | null) => {\n    if (node != null) {\n      if (instanceRef.current != null) {\n        throw new Error(\n          'File: An instance should not already exist when a node is created'\n        );\n      }\n      // FIXME: Ideally we don't use FileUI here, and instead amalgamate\n      // the renderers manually\n      instanceRef.current = new File(options, poolManager, true);\n      void instanceRef.current.hydrate({\n        file,\n        fileContainer: node,\n        lineAnnotations,\n        prerenderedHTML,\n      });\n    } else {\n      if (instanceRef.current == null) {\n        throw new Error('File: A File instance should exist when unmounting');\n      }\n      instanceRef.current.cleanUp();\n      instanceRef.current = null;\n    }\n  });\n\n  useIsometricEffect(() => {\n    if (instanceRef.current == null) return;\n    const forceRender = !areOptionsEqual(instanceRef.current.options, options);\n    instanceRef.current.setOptions(options);\n    void instanceRef.current.render({ file, lineAnnotations, forceRender });\n    if (selectedLines !== undefined) {\n      instanceRef.current.setSelectedLines(selectedLines);\n    }\n  });\n\n  const getHoveredLine = useCallback(():\n    | GetHoveredLineResult<'file'>\n    | undefined => {\n    return instanceRef.current?.getHoveredLine();\n  }, []);\n  return { ref, getHoveredLine };\n}\n"],"mappings":";;;;;;;AAgBA,MAAM,qBACJ,OAAO,WAAW,cAAc,YAAY;AAe9C,SAAgB,gBAA6B,EAC3C,MACA,SACA,iBACA,eACA,mBAC2D;CAC3D,MAAM,cAAc,WAAW,kBAAkB;CACjD,MAAM,cAAc,OAAiC,KAAK;CAC1D,MAAM,MAAM,mBAAmB,SAA6B;AAC1D,MAAI,QAAQ,MAAM;AAChB,OAAI,YAAY,WAAW,KACzB,OAAM,IAAI,MACR,oEACD;AAIH,eAAY,UAAU,IAAI,KAAK,SAAS,aAAa,KAAK;AAC1D,GAAK,YAAY,QAAQ,QAAQ;IAC/B;IACA,eAAe;IACf;IACA;IACD,CAAC;SACG;AACL,OAAI,YAAY,WAAW,KACzB,OAAM,IAAI,MAAM,qDAAqD;AAEvE,eAAY,QAAQ,SAAS;AAC7B,eAAY,UAAU;;GAExB;AAEF,0BAAyB;AACvB,MAAI,YAAY,WAAW,KAAM;EACjC,MAAM,cAAc,CAAC,gBAAgB,YAAY,QAAQ,SAAS,QAAQ;AAC1E,cAAY,QAAQ,WAAW,QAAQ;AACvC,EAAK,YAAY,QAAQ,OAAO;GAAE;GAAM;GAAiB;GAAa,CAAC;AACvE,MAAI,kBAAkB,OACpB,aAAY,QAAQ,iBAAiB,cAAc;GAErD;AAOF,QAAO;EAAE;EAAK,gBALS,kBAEN;AACf,UAAO,YAAY,SAAS,gBAAgB;KAC3C,EAAE,CAAC;EACwB"}