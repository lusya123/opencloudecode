{"version":3,"file":"FileDiffReact.js","names":["annotation"],"sources":["../../src/ssr/FileDiffReact.tsx"],"sourcesContent":["'use client';\n\nimport { type CSSProperties, type ReactNode, useEffect, useRef } from 'react';\nimport { hydrateRoot } from 'react-dom/client';\nimport { renderToString } from 'react-dom/server';\n\nimport { DIFFS_TAG_NAME } from '../constants';\nimport type { DiffLineAnnotation } from '../types';\nimport { getLineAnnotationName } from '../utils/getLineAnnotationName';\n\ninterface FileDiffSsrProps<LAnnotation> {\n  prerenderedHTML: string;\n  annotations?: DiffLineAnnotation<LAnnotation>[];\n  renderAnnotation?(annotations: DiffLineAnnotation<LAnnotation>): ReactNode;\n  className?: string;\n  style?: CSSProperties;\n}\n\nfunction escapeHtml(unsafe: string): string {\n  return unsafe\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\nfunction serializeStyle(style: CSSProperties): string {\n  return Object.entries(style)\n    .map(([key, value]) => {\n      // Convert camelCase to kebab-case\n      const kebabKey = key.replace(/([A-Z])/g, '-$1').toLowerCase();\n      // Escape the value for safety\n      return `${kebabKey}:${escapeHtml(String(value))}`;\n    })\n    .join(';');\n}\n\nexport function FileDiffSSR<LAnnotation>({\n  prerenderedHTML,\n  annotations,\n  className,\n  style,\n  renderAnnotation,\n}: FileDiffSsrProps<LAnnotation>): React.JSX.Element {\n  const wrapperRef = useRef<HTMLDivElement>(null);\n  const hydratedRef = useRef(false);\n\n  // Store the HTML object in a ref so it has a stable reference\n  // This prevents React from trying to update innerHTML on every render\n  const htmlObjectRef = useRef<{ __html: string } | null>(null);\n\n  if (htmlObjectRef.current === null) {\n    // Build the full HTML string with the custom element and DSD\n    const classAttr =\n      className !== undefined ? ` class=\"${escapeHtml(className)}\"` : '';\n    const styleAttr =\n      style !== undefined ? ` style=\"${serializeStyle(style)}\"` : '';\n\n    // Render annotations as static HTML slots for SSR\n    const annotationSlots =\n      annotations !== undefined &&\n      annotations.length > 0 &&\n      renderAnnotation != null\n        ? annotations\n            .map((annotation) => {\n              const slotName = getLineAnnotationName(annotation);\n              // Render the component with React markers for proper hydration\n              const content = renderToString(renderAnnotation(annotation));\n              return `<div slot=\"${slotName}\">${content}</div>`;\n            })\n            .join('')\n        : '';\n\n    const fullHTML = `<${DIFFS_TAG_NAME}${classAttr}${styleAttr}><template shadowrootmode=\"open\">${prerenderedHTML}</template>${annotationSlots}</${DIFFS_TAG_NAME}>`;\n\n    htmlObjectRef.current = { __html: fullHTML };\n  }\n\n  useEffect(() => {\n    // After mount, hydrate the slots with React using render functions\n    if (\n      wrapperRef.current !== null &&\n      annotations !== undefined &&\n      !hydratedRef.current\n    ) {\n      const fileElement = wrapperRef.current.querySelector(DIFFS_TAG_NAME);\n\n      if (fileElement !== null) {\n        Array.from(fileElement.children).forEach((slotElement) => {\n          if (!(slotElement instanceof HTMLElement)) return;\n\n          const slotName = slotElement.getAttribute('slot');\n          if (slotName === null) return;\n\n          // Find the matching annotation\n          const annotation = annotations.find((annotation) => {\n            return slotName === getLineAnnotationName(annotation);\n          });\n\n          if (annotation !== undefined && renderAnnotation != null) {\n            hydrateRoot(slotElement, renderAnnotation(annotation));\n          }\n        });\n\n        hydratedRef.current = true;\n      }\n    }\n  }, [annotations, renderAnnotation]);\n\n  return (\n    <div\n      ref={wrapperRef}\n      dangerouslySetInnerHTML={htmlObjectRef.current}\n      suppressHydrationWarning\n    />\n  );\n}\n"],"mappings":";;;;;;;;;;;AAkBA,SAAS,WAAW,QAAwB;AAC1C,QAAO,OACJ,QAAQ,MAAM,QAAQ,CACtB,QAAQ,MAAM,OAAO,CACrB,QAAQ,MAAM,OAAO,CACrB,QAAQ,MAAM,SAAS,CACvB,QAAQ,MAAM,SAAS;;AAG5B,SAAS,eAAe,OAA8B;AACpD,QAAO,OAAO,QAAQ,MAAM,CACzB,KAAK,CAAC,KAAK,WAAW;AAIrB,SAAO,GAFU,IAAI,QAAQ,YAAY,MAAM,CAAC,aAAa,CAE1C,GAAG,WAAW,OAAO,MAAM,CAAC;GAC/C,CACD,KAAK,IAAI;;AAGd,SAAgB,YAAyB,EACvC,iBACA,aACA,WACA,OACA,oBACmD;CACnD,MAAM,aAAa,OAAuB,KAAK;CAC/C,MAAM,cAAc,OAAO,MAAM;CAIjC,MAAM,gBAAgB,OAAkC,KAAK;AAE7D,KAAI,cAAc,YAAY,KAwB5B,eAAc,UAAU,EAAE,QAFT,IAAI,iBAnBnB,cAAc,SAAY,WAAW,WAAW,UAAU,CAAC,KAAK,KAEhE,UAAU,SAAY,WAAW,eAAe,MAAM,CAAC,KAAK,GAiBF,mCAAmC,gBAAgB,aAb7G,gBAAgB,UAChB,YAAY,SAAS,KACrB,oBAAoB,OAChB,YACG,KAAK,eAAe;AAInB,SAAO,cAHU,sBAAsB,WAAW,CAGpB,IADd,eAAe,iBAAiB,WAAW,CAAC,CAClB;GAC1C,CACD,KAAK,GAAG,GACX,GAEsI,IAAI,eAAe,IAEnH;AAG9C,iBAAgB;AAEd,MACE,WAAW,YAAY,QACvB,gBAAgB,UAChB,CAAC,YAAY,SACb;GACA,MAAM,cAAc,WAAW,QAAQ,cAAc,eAAe;AAEpE,OAAI,gBAAgB,MAAM;AACxB,UAAM,KAAK,YAAY,SAAS,CAAC,SAAS,gBAAgB;AACxD,SAAI,EAAE,uBAAuB,aAAc;KAE3C,MAAM,WAAW,YAAY,aAAa,OAAO;AACjD,SAAI,aAAa,KAAM;KAGvB,MAAM,aAAa,YAAY,MAAM,iBAAe;AAClD,aAAO,aAAa,sBAAsBA,aAAW;OACrD;AAEF,SAAI,eAAe,UAAa,oBAAoB,KAClD,aAAY,aAAa,iBAAiB,WAAW,CAAC;MAExD;AAEF,gBAAY,UAAU;;;IAGzB,CAAC,aAAa,iBAAiB,CAAC;AAEnC,QACE,oBAAC;EACC,KAAK;EACL,yBAAyB,cAAc;EACvC;GACA"}