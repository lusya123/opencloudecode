{"version":3,"file":"FileDiff.js","names":["options: FileDiffOptions<LAnnotation>","workerManager?: WorkerPoolManager | undefined","error: unknown","codeDeletions: HTMLElement | undefined","codeAdditions: HTMLElement | undefined"],"sources":["../../src/components/FileDiff.ts"],"sourcesContent":["import type { Element as HASTElement } from 'hast';\nimport { toHtml } from 'hast-util-to-html';\n\nimport {\n  DEFAULT_THEMES,\n  DIFFS_TAG_NAME,\n  HEADER_METADATA_SLOT_ID,\n  UNSAFE_CSS_ATTRIBUTE,\n} from '../constants';\nimport {\n  LineSelectionManager,\n  type LineSelectionOptions,\n  type SelectedLineRange,\n  pluckLineSelectionOptions,\n} from '../managers/LineSelectionManager';\nimport {\n  type GetHoveredLineResult,\n  MouseEventManager,\n  type MouseEventManagerBaseOptions,\n  pluckMouseEventOptions,\n} from '../managers/MouseEventManager';\nimport { ResizeManager } from '../managers/ResizeManager';\nimport { ScrollSyncManager } from '../managers/ScrollSyncManager';\nimport {\n  DiffHunksRenderer,\n  type HunksRenderResult,\n} from '../renderers/DiffHunksRenderer';\nimport { SVGSpriteSheet } from '../sprite';\nimport type {\n  BaseDiffOptions,\n  DiffLineAnnotation,\n  ExpansionDirections,\n  FileContents,\n  FileDiffMetadata,\n  HunkData,\n  HunkSeparators,\n  RenderHeaderMetadataCallback,\n  ThemeTypes,\n} from '../types';\nimport { areFilesEqual } from '../utils/areFilesEqual';\nimport { createAnnotationWrapperNode } from '../utils/createAnnotationWrapperNode';\nimport { createCodeNode } from '../utils/createCodeNode';\nimport { createHoverContentNode } from '../utils/createHoverContentNode';\nimport { createUnsafeCSSStyleNode } from '../utils/createUnsafeCSSStyleNode';\nimport { wrapUnsafeCSS } from '../utils/cssWrappers';\nimport { getLineAnnotationName } from '../utils/getLineAnnotationName';\nimport { parseDiffFromFile } from '../utils/parseDiffFromFile';\nimport { prerenderHTMLIfNecessary } from '../utils/prerenderHTMLIfNecessary';\nimport { setPreNodeProperties } from '../utils/setWrapperNodeProps';\nimport type { WorkerPoolManager } from '../worker';\nimport { DiffsContainerLoaded } from './web-components';\n\nexport interface FileDiffRenderProps<LAnnotation> {\n  fileDiff?: FileDiffMetadata;\n  oldFile?: FileContents;\n  newFile?: FileContents;\n  forceRender?: boolean;\n  fileContainer?: HTMLElement;\n  containerWrapper?: HTMLElement;\n  lineAnnotations?: DiffLineAnnotation<LAnnotation>[];\n}\n\nexport interface FileDiffHydrationProps<LAnnotation>\n  extends Omit<FileDiffRenderProps<LAnnotation>, 'fileContainer'> {\n  fileContainer: HTMLElement;\n  prerenderedHTML?: string;\n}\n\nexport interface FileDiffOptions<LAnnotation>\n  extends Omit<BaseDiffOptions, 'hunkSeparators'>,\n    MouseEventManagerBaseOptions<'diff'>,\n    LineSelectionOptions {\n  hunkSeparators?:\n    | Exclude<HunkSeparators, 'custom'>\n    | ((\n        hunk: HunkData,\n        instance: FileDiff<LAnnotation>\n      ) => HTMLElement | DocumentFragment);\n  disableFileHeader?: boolean;\n  renderHeaderMetadata?: RenderHeaderMetadataCallback;\n  renderAnnotation?(\n    annotation: DiffLineAnnotation<LAnnotation>\n  ): HTMLElement | undefined;\n  renderHoverUtility?(\n    getHoveredRow: () => GetHoveredLineResult<'diff'> | undefined\n  ): HTMLElement | null;\n}\n\nlet instanceId = -1;\n\nexport class FileDiff<LAnnotation = undefined> {\n  // NOTE(amadeus): We sorta need this to ensure the web-component file is\n  // properly loaded\n  static LoadedCustomComponent: boolean = DiffsContainerLoaded;\n\n  readonly __id: number = ++instanceId;\n\n  private fileContainer: HTMLElement | undefined;\n  private spriteSVG: SVGElement | undefined;\n  private pre: HTMLPreElement | undefined;\n  private unsafeCSSStyle: HTMLStyleElement | undefined;\n  private hoverContent: HTMLElement | undefined;\n\n  private headerElement: HTMLElement | undefined;\n  private headerMetadata: HTMLElement | undefined;\n  private customHunkElements: HTMLElement[] = [];\n  private errorWrapper: HTMLElement | undefined;\n\n  private hunksRenderer: DiffHunksRenderer<LAnnotation>;\n  private resizeManager: ResizeManager;\n  private scrollSyncManager: ScrollSyncManager;\n  private mouseEventManager: MouseEventManager<'diff'>;\n  private lineSelectionManager: LineSelectionManager;\n\n  private annotationElements: HTMLElement[] = [];\n  private lineAnnotations: DiffLineAnnotation<LAnnotation>[] = [];\n\n  private oldFile: FileContents | undefined;\n  private newFile: FileContents | undefined;\n  private fileDiff: FileDiffMetadata | undefined;\n\n  constructor(\n    public options: FileDiffOptions<LAnnotation> = { theme: DEFAULT_THEMES },\n    private workerManager?: WorkerPoolManager | undefined,\n    // NOTE(amadeus): Temp hack while we use this component in a react context\n    private isContainerManaged = false\n  ) {\n    this.hunksRenderer = new DiffHunksRenderer(\n      {\n        ...options,\n        hunkSeparators:\n          typeof options.hunkSeparators === 'function'\n            ? 'custom'\n            : options.hunkSeparators,\n      },\n      this.handleHighlightRender,\n      this.workerManager\n    );\n    this.resizeManager = new ResizeManager();\n    this.scrollSyncManager = new ScrollSyncManager();\n    this.mouseEventManager = new MouseEventManager(\n      'diff',\n      pluckMouseEventOptions(\n        options,\n        typeof options.hunkSeparators === 'function' ||\n          (options.hunkSeparators ?? 'line-info') === 'line-info'\n          ? this.handleExpandHunk\n          : undefined\n      )\n    );\n    this.lineSelectionManager = new LineSelectionManager(\n      pluckLineSelectionOptions(options)\n    );\n    this.workerManager?.subscribeToThemeChanges(this);\n  }\n\n  private handleHighlightRender = (): void => {\n    this.rerender();\n  };\n\n  // FIXME(amadeus): This is a bit of a looming issue that I'll need to resolve:\n  // * Do we publicly allow merging of options or do we have individualized setters?\n  // * When setting new options, we need to figure out what settings require a\n  //   re-render and which can just be applied more elegantly\n  // * There's also an issue of options that live here on the File class and\n  //   those that live on the Hunk class, and it's a bit of an issue with passing\n  //   settings down and mirroring them (not great...)\n  setOptions(options: FileDiffOptions<LAnnotation> | undefined): void {\n    if (options == null) return;\n    this.options = options;\n    this.hunksRenderer.setOptions({\n      ...this.options,\n      hunkSeparators:\n        typeof options.hunkSeparators === 'function'\n          ? 'custom'\n          : options.hunkSeparators,\n    });\n    this.mouseEventManager.setOptions(\n      pluckMouseEventOptions(\n        options,\n        typeof options.hunkSeparators === 'function' ||\n          (options.hunkSeparators ?? 'line-info') === 'line-info'\n          ? this.handleExpandHunk\n          : undefined\n      )\n    );\n    this.lineSelectionManager.setOptions(pluckLineSelectionOptions(options));\n  }\n\n  private mergeOptions(options: Partial<FileDiffOptions<LAnnotation>>): void {\n    this.options = { ...this.options, ...options };\n  }\n\n  setThemeType(themeType: ThemeTypes): void {\n    if ((this.options.themeType ?? 'system') === themeType) {\n      return;\n    }\n    this.mergeOptions({ themeType });\n    this.hunksRenderer.setThemeType(themeType);\n\n    if (this.headerElement != null) {\n      if (themeType === 'system') {\n        delete this.headerElement.dataset.themeType;\n      } else {\n        this.headerElement.dataset.themeType = themeType;\n      }\n    }\n\n    // Update pre element theme mode\n    if (this.pre != null) {\n      switch (themeType) {\n        case 'system':\n          delete this.pre.dataset.themeType;\n          break;\n        case 'light':\n        case 'dark':\n          this.pre.dataset.themeType = themeType;\n          break;\n      }\n    }\n  }\n\n  getHoveredLine = (): GetHoveredLineResult<'diff'> | undefined => {\n    return this.mouseEventManager.getHoveredLine();\n  };\n\n  setLineAnnotations(lineAnnotations: DiffLineAnnotation<LAnnotation>[]): void {\n    this.lineAnnotations = lineAnnotations;\n  }\n\n  setSelectedLines(range: SelectedLineRange | null): void {\n    this.lineSelectionManager.setSelection(range);\n  }\n\n  cleanUp(): void {\n    this.hunksRenderer.cleanUp();\n    this.resizeManager.cleanUp();\n    this.mouseEventManager.cleanUp();\n    this.scrollSyncManager.cleanUp();\n    this.lineSelectionManager.cleanUp();\n    this.workerManager?.unsubscribeToThemeChanges(this);\n    this.workerManager = undefined;\n\n    // Clean up the data\n    this.fileDiff = undefined;\n    this.oldFile = undefined;\n    this.newFile = undefined;\n\n    // Clean up the elements\n    if (!this.isContainerManaged) {\n      this.fileContainer?.parentNode?.removeChild(this.fileContainer);\n    }\n    if (this.fileContainer?.shadowRoot != null) {\n      this.fileContainer.shadowRoot.innerHTML = '';\n    }\n    this.fileContainer = undefined;\n    this.pre = undefined;\n    this.headerElement = undefined;\n    this.errorWrapper = undefined;\n  }\n\n  hydrate(props: FileDiffHydrationProps<LAnnotation>): void {\n    const { fileContainer, prerenderedHTML } = props;\n    prerenderHTMLIfNecessary(fileContainer, prerenderedHTML);\n    for (const element of Array.from(\n      fileContainer.shadowRoot?.children ?? []\n    )) {\n      if (element instanceof SVGElement) {\n        this.spriteSVG = element;\n        continue;\n      }\n      if (!(element instanceof HTMLElement)) {\n        continue;\n      }\n      if (element instanceof HTMLPreElement) {\n        this.pre = element;\n        continue;\n      }\n      if ('diffsHeader' in element.dataset) {\n        this.headerElement = element;\n        continue;\n      }\n      if (\n        element instanceof HTMLStyleElement &&\n        element.hasAttribute(UNSAFE_CSS_ATTRIBUTE)\n      ) {\n        this.unsafeCSSStyle = element;\n        continue;\n      }\n    }\n    // If we have no pre tag, then we should render\n    if (this.pre == null) {\n      this.render(props);\n    }\n    // Otherwise orchestrate our setup\n    else {\n      const { lineAnnotations, oldFile, newFile, fileDiff } = props;\n      this.fileContainer = fileContainer;\n      delete this.pre.dataset.dehydrated;\n\n      this.lineAnnotations = lineAnnotations ?? this.lineAnnotations;\n      this.newFile = newFile;\n      this.oldFile = oldFile;\n      this.fileDiff =\n        fileDiff ??\n        (oldFile != null && newFile != null\n          ? parseDiffFromFile(oldFile, newFile)\n          : undefined);\n\n      this.hunksRenderer.hydrate(this.fileDiff);\n      // FIXME(amadeus): not sure how to handle this yet...\n      // this.renderSeparators();\n      this.renderAnnotations();\n      this.renderHoverUtility();\n      this.injectUnsafeCSS();\n      this.mouseEventManager.setup(this.pre);\n      this.lineSelectionManager.setup(this.pre);\n      if ((this.options.overflow ?? 'scroll') === 'scroll') {\n        this.resizeManager.setup(this.pre);\n        this.scrollSyncManager.setup(this.pre);\n      }\n    }\n  }\n\n  rerender(): void {\n    if (this.fileDiff == null && this.newFile == null && this.oldFile == null) {\n      return;\n    }\n    this.render({\n      oldFile: this.oldFile,\n      newFile: this.newFile,\n      fileDiff: this.fileDiff,\n      forceRender: true,\n    });\n  }\n\n  handleExpandHunk = (\n    hunkIndex: number,\n    direction: ExpansionDirections\n  ): void => {\n    this.expandHunk(hunkIndex, direction);\n  };\n\n  expandHunk(hunkIndex: number, direction: ExpansionDirections): void {\n    this.hunksRenderer.expandHunk(hunkIndex, direction);\n    this.rerender();\n  }\n\n  render({\n    oldFile,\n    newFile,\n    fileDiff,\n    forceRender = false,\n    lineAnnotations,\n    fileContainer,\n    containerWrapper,\n  }: FileDiffRenderProps<LAnnotation>): void {\n    const filesDidChange =\n      oldFile != null &&\n      newFile != null &&\n      (!areFilesEqual(oldFile, this.oldFile) ||\n        !areFilesEqual(newFile, this.newFile));\n    const annotationsChanged =\n      lineAnnotations != null &&\n      (lineAnnotations.length > 0 || this.lineAnnotations.length > 0)\n        ? lineAnnotations !== this.lineAnnotations\n        : false;\n    if (\n      !forceRender &&\n      !annotationsChanged &&\n      // If using the fileDiff API, lets check to see if they are equal to\n      // avoid doing work\n      ((fileDiff != null && fileDiff === this.fileDiff) ||\n        // If using the oldFile/newFile API then lets check to see if they are\n        // equal\n        (fileDiff == null && !filesDidChange))\n    ) {\n      return;\n    }\n\n    this.oldFile = oldFile;\n    this.newFile = newFile;\n    if (fileDiff != null) {\n      this.fileDiff = fileDiff;\n    } else if (oldFile != null && newFile != null && filesDidChange) {\n      this.fileDiff = parseDiffFromFile(oldFile, newFile);\n    }\n\n    if (lineAnnotations != null) {\n      this.setLineAnnotations(lineAnnotations);\n    }\n    if (this.fileDiff == null) {\n      return;\n    }\n    this.hunksRenderer.setOptions({\n      ...this.options,\n      hunkSeparators:\n        typeof this.options.hunkSeparators === 'function'\n          ? 'custom'\n          : this.options.hunkSeparators,\n    });\n\n    this.hunksRenderer.setLineAnnotations(this.lineAnnotations);\n\n    const { disableFileHeader = false } = this.options;\n\n    if (disableFileHeader) {\n      // Remove existing header from DOM\n      if (this.headerElement != null) {\n        this.headerElement.parentNode?.removeChild(this.headerElement);\n        this.headerElement = undefined;\n      }\n    }\n    fileContainer = this.getOrCreateFileContainer(\n      fileContainer,\n      containerWrapper\n    );\n\n    try {\n      const hunksResult = this.hunksRenderer.renderDiff(this.fileDiff);\n      if (hunksResult == null) {\n        if (this.workerManager != null && !this.workerManager.isInitialized()) {\n          void this.workerManager.initialize().then(() => this.rerender());\n        }\n        return;\n      }\n\n      if (hunksResult.headerElement != null) {\n        this.applyHeaderToDOM(hunksResult.headerElement, fileContainer);\n      }\n      const pre = this.getOrCreatePreNode(fileContainer);\n      this.applyHunksToDOM(pre, hunksResult);\n      this.renderSeparators(hunksResult.hunkData);\n      this.renderAnnotations();\n      this.renderHoverUtility();\n    } catch (error: unknown) {\n      if (error instanceof Error) {\n        this.applyErrorToDOM(error, fileContainer);\n      }\n    }\n  }\n\n  private renderSeparators(hunkData: HunkData[]): void {\n    const { hunkSeparators } = this.options;\n    if (\n      this.isContainerManaged ||\n      this.fileContainer == null ||\n      typeof hunkSeparators !== 'function'\n    ) {\n      return;\n    }\n    for (const element of this.customHunkElements) {\n      element.parentNode?.removeChild(element);\n    }\n    this.customHunkElements.length = 0;\n    for (const hunk of hunkData) {\n      const element = document.createElement('div');\n      element.style.display = 'contents';\n      element.slot = hunk.slotName;\n      element.appendChild(hunkSeparators(hunk, this));\n      this.fileContainer.appendChild(element);\n      this.customHunkElements.push(element);\n    }\n  }\n\n  private renderAnnotations(): void {\n    if (this.isContainerManaged || this.fileContainer == null) {\n      return;\n    }\n    // Handle annotation elements\n    for (const element of this.annotationElements) {\n      element.parentNode?.removeChild(element);\n    }\n    this.annotationElements.length = 0;\n\n    const { renderAnnotation } = this.options;\n    if (renderAnnotation != null && this.lineAnnotations.length > 0) {\n      for (const annotation of this.lineAnnotations) {\n        const content = renderAnnotation(annotation);\n        if (content == null) continue;\n        const el = createAnnotationWrapperNode(\n          getLineAnnotationName(annotation)\n        );\n        el.appendChild(content);\n        this.annotationElements.push(el);\n        this.fileContainer.appendChild(el);\n      }\n    }\n  }\n\n  private renderHoverUtility() {\n    const { renderHoverUtility } = this.options;\n    if (this.fileContainer == null || renderHoverUtility == null) return;\n    if (this.hoverContent == null) {\n      this.hoverContent = createHoverContentNode();\n      this.fileContainer.appendChild(this.hoverContent);\n    }\n    const element = renderHoverUtility(this.mouseEventManager.getHoveredLine);\n    this.hoverContent.innerHTML = '';\n    if (element != null) {\n      this.hoverContent.appendChild(element);\n    }\n  }\n\n  private getOrCreateFileContainer(\n    fileContainer?: HTMLElement,\n    parentNode?: HTMLElement\n  ): HTMLElement {\n    this.fileContainer =\n      fileContainer ??\n      this.fileContainer ??\n      document.createElement(DIFFS_TAG_NAME);\n    if (parentNode != null && this.fileContainer.parentNode !== parentNode) {\n      parentNode.appendChild(this.fileContainer);\n    }\n    if (this.spriteSVG == null) {\n      const fragment = document.createElement('div');\n      fragment.innerHTML = SVGSpriteSheet;\n      const firstChild = fragment.firstChild;\n      if (firstChild instanceof SVGElement) {\n        this.spriteSVG = firstChild;\n        this.fileContainer.shadowRoot?.appendChild(this.spriteSVG);\n      }\n    }\n    return this.fileContainer;\n  }\n\n  getFileContainer(): HTMLElement | undefined {\n    return this.fileContainer;\n  }\n\n  private getOrCreatePreNode(container: HTMLElement): HTMLPreElement {\n    // If we haven't created a pre element yet, lets go ahead and do that\n    if (this.pre == null) {\n      this.pre = document.createElement('pre');\n      container.shadowRoot?.appendChild(this.pre);\n    }\n    // If we have a new parent container for the pre element, lets go ahead and\n    // move it into the new container\n    else if (this.pre.parentNode !== container) {\n      container.shadowRoot?.appendChild(this.pre);\n    }\n    return this.pre;\n  }\n\n  private applyHeaderToDOM(\n    headerAST: HASTElement,\n    container: HTMLElement\n  ): void {\n    this.cleanupErrorWrapper();\n    const tempDiv = document.createElement('div');\n    tempDiv.innerHTML = toHtml(headerAST);\n    const newHeader = tempDiv.firstElementChild;\n    if (!(newHeader instanceof HTMLElement)) {\n      return;\n    }\n    if (this.headerElement != null) {\n      container.shadowRoot?.replaceChild(newHeader, this.headerElement);\n    } else {\n      container.shadowRoot?.prepend(newHeader);\n    }\n    this.headerElement = newHeader;\n\n    if (this.isContainerManaged) return;\n\n    const { renderHeaderMetadata } = this.options;\n    if (this.headerMetadata != null) {\n      this.headerMetadata.parentNode?.removeChild(this.headerMetadata);\n    }\n    const content =\n      renderHeaderMetadata?.({\n        oldFile: this.oldFile,\n        newFile: this.newFile,\n        fileDiff: this.fileDiff,\n      }) ?? undefined;\n    if (content != null) {\n      this.headerMetadata = document.createElement('div');\n      this.headerMetadata.slot = HEADER_METADATA_SLOT_ID;\n      if (content instanceof Element) {\n        this.headerMetadata.appendChild(content);\n      } else {\n        this.headerMetadata.innerText = `${content}`;\n      }\n      container.appendChild(this.headerMetadata);\n    }\n  }\n\n  private injectUnsafeCSS(): void {\n    if (this.fileContainer?.shadowRoot == null) {\n      return;\n    }\n    const { unsafeCSS } = this.options;\n\n    if (unsafeCSS == null || unsafeCSS === '') {\n      return;\n    }\n\n    // Create or update the style element\n    if (this.unsafeCSSStyle == null) {\n      this.unsafeCSSStyle = createUnsafeCSSStyleNode();\n      this.fileContainer.shadowRoot.appendChild(this.unsafeCSSStyle);\n    }\n    // Wrap in @layer unsafe to match SSR behavior\n    this.unsafeCSSStyle.innerText = wrapUnsafeCSS(unsafeCSS);\n  }\n\n  private applyHunksToDOM(\n    pre: HTMLPreElement,\n    result: HunksRenderResult\n  ): void {\n    this.cleanupErrorWrapper();\n    this.applyPreNodeAttributes(pre, result);\n\n    // Clear existing content\n    pre.innerHTML = '';\n\n    let codeDeletions: HTMLElement | undefined;\n    let codeAdditions: HTMLElement | undefined;\n    // Create code elements and insert HTML content\n    if (result.unifiedAST != null) {\n      const codeUnified = createCodeNode({ columnType: 'unified' });\n      codeUnified.innerHTML = this.hunksRenderer.renderPartialHTML(\n        result.unifiedAST\n      );\n      pre.appendChild(codeUnified);\n    } else {\n      if (result.deletionsAST != null) {\n        codeDeletions = createCodeNode({ columnType: 'deletions' });\n        codeDeletions.innerHTML = this.hunksRenderer.renderPartialHTML(\n          result.deletionsAST\n        );\n        pre.appendChild(codeDeletions);\n      }\n      if (result.additionsAST != null) {\n        codeAdditions = createCodeNode({ columnType: 'additions' });\n        codeAdditions.innerHTML = this.hunksRenderer.renderPartialHTML(\n          result.additionsAST\n        );\n        pre.appendChild(codeAdditions);\n      }\n    }\n\n    this.injectUnsafeCSS();\n\n    this.mouseEventManager.setup(pre);\n    this.lineSelectionManager.setup(pre);\n    if ((this.options.overflow ?? 'scroll') === 'scroll') {\n      this.resizeManager.setup(pre);\n      this.scrollSyncManager.setup(pre, codeDeletions, codeAdditions);\n    } else {\n      this.resizeManager.cleanUp();\n      this.scrollSyncManager.cleanUp();\n    }\n  }\n\n  private applyPreNodeAttributes(\n    pre: HTMLPreElement,\n    {\n      themeStyles,\n      baseThemeType,\n      additionsAST,\n      deletionsAST,\n      totalLines,\n    }: HunksRenderResult\n  ): void {\n    const {\n      diffIndicators = 'bars',\n      disableBackground = false,\n      disableLineNumbers = false,\n      overflow = 'scroll',\n      themeType = 'system',\n      diffStyle = 'split',\n    } = this.options;\n    const split =\n      diffStyle === 'unified'\n        ? false\n        : additionsAST != null && deletionsAST != null;\n    setPreNodeProperties({\n      pre,\n      diffIndicators,\n      disableBackground,\n      disableLineNumbers,\n      overflow,\n      split,\n      themeStyles,\n      themeType: baseThemeType ?? themeType,\n      totalLines,\n    });\n  }\n\n  private applyErrorToDOM(error: Error, container: HTMLElement) {\n    this.cleanupErrorWrapper();\n    const pre = this.getOrCreatePreNode(container);\n    pre.innerHTML = '';\n    pre.parentNode?.removeChild(pre);\n    this.pre = undefined;\n    const shadowRoot =\n      container.shadowRoot ?? container.attachShadow({ mode: 'open' });\n    this.errorWrapper ??= document.createElement('div');\n    this.errorWrapper.dataset.errorWrapper = '';\n    this.errorWrapper.innerHTML = '';\n    shadowRoot.appendChild(this.errorWrapper);\n    const errorMessage = document.createElement('div');\n    errorMessage.dataset.errorMessage = '';\n    errorMessage.innerText = error.message;\n    this.errorWrapper.appendChild(errorMessage);\n    const errorStack = document.createElement('pre');\n    errorStack.dataset.errorStack = '';\n    errorStack.innerText = error.stack ?? 'No Error Stack';\n    this.errorWrapper.appendChild(errorStack);\n  }\n\n  private cleanupErrorWrapper() {\n    this.errorWrapper?.parentNode?.removeChild(this.errorWrapper);\n    this.errorWrapper = undefined;\n  }\n}\n"],"mappings":"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"}