name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.1)'
        required: true
        default: 'v1.0.1'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            rust_target: x86_64-unknown-linux-gnu
          - os: ubuntu-24.04-arm
            platform: linux-arm64
            rust_target: aarch64-unknown-linux-gnu
          - os: macos-latest
            platform: darwin-arm64
            rust_target: aarch64-apple-darwin
          # darwin-x64 通过交叉编译在 darwin-arm64 上构建
          - os: macos-latest
            platform: darwin-x64
            rust_target: x86_64-apple-darwin
            cross_compile: true

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libglib2.0-dev

      - name: Install dependencies
        run: |
          # Install monorepo dependencies first
          cd opencode-dev
          bun install
          cd ../opencode-pro
          bun install

      - name: Build frontend
        run: |
          cd opencode-pro
          bun run build

      - name: Build opencode binary
        run: |
          cd opencode-dev/packages/opencode
          # Generate inlined theme data to work around Bun compile JSON import issue
          bun run scripts/inline-json.ts
          # Use the existing build script which properly handles JSX transformation
          # --single builds only for the current platform
          bun run build --single --skip-install
          # Find and copy the binary to the expected location
          BINARY_PATH=$(find dist -name "opencode" -type f 2>/dev/null | head -1)
          if [ -n "$BINARY_PATH" ]; then
            cp "$BINARY_PATH" ./opencode
            chmod +x ./opencode
            echo "Binary found at: $BINARY_PATH"
            ls -la opencode
          else
            echo "Binary not found in dist/"
            find dist -type f 2>/dev/null || echo "dist/ directory empty or not found"
          fi

      - name: Build cc-switch-server
        continue-on-error: true
        run: |
          cd cc-switch-main/src-tauri
          if [ "${{ matrix.cross_compile }}" = "true" ]; then
            rustup target add ${{ matrix.rust_target }}
            cargo build --release --bin cc-switch-server --target=${{ matrix.rust_target }} || echo "cc-switch build failed"
            mkdir -p ../target/release
            cp target/${{ matrix.rust_target }}/release/cc-switch-server ../target/release/ || true
          else
            cargo build --release --bin cc-switch-server || echo "cc-switch build failed"
          fi

      - name: Package release
        run: |
          mkdir -p release/opencode/bin
          mkdir -p release/opencode/web
          mkdir -p release/opencode/systemd
          mkdir -p release/opencode/backend

          # Copy frontend
          cp -a opencode-pro/packages/app/dist/* release/opencode/web/

          # Copy binaries
          if [ -f opencode-dev/packages/opencode/opencode ]; then
            cp opencode-dev/packages/opencode/opencode release/opencode/bin/
          fi
          cp cc-switch-main/src-tauri/target/release/cc-switch-server release/opencode/bin/ || true

          # Copy backend source as fallback
          cp -a opencode-dev/packages/opencode/src release/opencode/backend/
          cp opencode-dev/packages/opencode/package.json release/opencode/backend/

          # Copy config files
          cp .env.example release/opencode/ || echo "OPENCODE_SERVER_PASSWORD=" > release/opencode/.env.example
          cp packaging/systemd/opencode.service release/opencode/systemd/ || true

          # Create start script
          cat > release/opencode/start.sh << 'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          if [[ -x "${SCRIPT_DIR}/bin/opencode" ]]; then
            export OPENCODE_WEB_ROOT="${SCRIPT_DIR}/web"
            export CC_SWITCH_SERVER_PATH="${SCRIPT_DIR}/bin/cc-switch-server"
            exec "${SCRIPT_DIR}/bin/opencode" serve --mode prod --hostname 0.0.0.0 --port 4096
          else
            if ! command -v bun >/dev/null 2>&1; then
              curl -fsSL https://bun.sh/install | bash
              export PATH="${HOME}/.bun/bin:${PATH}"
            fi
            cd "${SCRIPT_DIR}/backend" && bun install
            export OPENCODE_WEB_ROOT="${SCRIPT_DIR}/web"
            export CC_SWITCH_SERVER_PATH="${SCRIPT_DIR}/bin/cc-switch-server"
            exec bun run --conditions=browser src/index.ts serve --mode prod --hostname 0.0.0.0 --port 4096
          fi
          EOF
          chmod +x release/opencode/start.sh

          # Copy install script from repository (includes auto-dependency installation)
          cp packaging/install.sh release/opencode/install.sh || cp install.sh release/opencode/install.sh
          chmod +x release/opencode/install.sh

          # Create tarball
          cd release
          tar -czf opencode-selfhost_${{ matrix.platform }}.tar.gz opencode

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencode-selfhost_${{ matrix.platform }}
          path: release/opencode-selfhost_${{ matrix.platform }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate checksums
        run: |
          cd artifacts
          find . -name "*.tar.gz" -exec mv {} . \;
          sha256sum *.tar.gz > SHA256SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.tar.gz
            artifacts/SHA256SUMS
          body: |
            ## 一键安装

            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
            ```

            ## 支持的平台

            - macOS Apple Silicon (darwin-arm64)
            - macOS Intel (darwin-x64)
            - Linux x64 (linux-x64)
            - Linux ARM64 (linux-arm64)

            ## 访问地址

            - Web: http://localhost:4096
            - API: http://localhost:4096/api
